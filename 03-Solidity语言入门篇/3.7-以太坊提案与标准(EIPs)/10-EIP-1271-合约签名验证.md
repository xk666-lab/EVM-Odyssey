# EIP-1271 åˆçº¦ç­¾åéªŒè¯

> ğŸ“ å¾…ç¼–å†™

## å­¦ä¹ ç›®æ ‡

- ç†è§£åˆçº¦ç­¾åçš„æ¦‚å¿µ
- æŒæ¡ isValidSignature æ¥å£
- äº†è§£æ™ºèƒ½é’±åŒ…çš„ç­¾åéªŒè¯
- å­¦ä¼šé›†æˆ EIP-1271

## å¤§çº²

### 1. ä¸ºä»€ä¹ˆéœ€è¦åˆçº¦ç­¾åï¼Ÿ

#### 1.1 ä¼ ç»Ÿç­¾åçš„å±€é™
```solidity
// åªèƒ½éªŒè¯ EOA çš„ç­¾å
address signer = ecrecover(hash, v, r, s);
```

#### 1.2 æ™ºèƒ½é’±åŒ…çš„éœ€æ±‚
- å¤šç­¾é’±åŒ…
- æ™ºèƒ½è´¦æˆ·
- DAO åˆçº¦

### 2. EIP-1271 æ¥å£

```solidity
interface IERC1271 {
    function isValidSignature(
        bytes32 hash,
        bytes memory signature
    ) external view returns (bytes4 magicValue);
}
```

#### 2.1 è¿”å›å€¼
```solidity
bytes4 constant MAGICVALUE = 0x1626ba7e;  // bytes4(keccak256("isValidSignature(bytes32,bytes)"))
```

### 3. å®ç°ç¤ºä¾‹

#### 3.1 å¤šç­¾é’±åŒ…
```solidity
contract MultiSigWallet is IERC1271 {
    address[] public owners;
    uint256 public threshold;
    
    function isValidSignature(
        bytes32 hash,
        bytes memory signature
    ) external view returns (bytes4) {
        // è§£æç­¾åä¸­çš„å¤šä¸ªç­¾å
        // éªŒè¯æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
        uint256 validSignatures = 0;
        // ... éªŒè¯é€»è¾‘
        
        if (validSignatures >= threshold) {
            return 0x1626ba7e;
        }
        return 0xffffffff;
    }
}
```

### 4. ä½¿ç”¨åœºæ™¯

- OpenSea è®¢å•ç­¾å
- Permit2
- é“¾ä¸‹ç­¾åéªŒè¯

### 5. éªŒè¯é€»è¾‘

```solidity
function verifySignature(
    address signer,
    bytes32 hash,
    bytes memory signature
) internal view returns (bool) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯åˆçº¦
    if (signer.code.length > 0) {
        // ä½¿ç”¨ EIP-1271
        try IERC1271(signer).isValidSignature(hash, signature) returns (bytes4 magicValue) {
            return magicValue == 0x1626ba7e;
        } catch {
            return false;
        }
    } else {
        // ä½¿ç”¨ ecrecover
        address recovered = ECDSA.recover(hash, signature);
        return recovered == signer;
    }
}
```

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] ç†è§£åˆçº¦ç­¾åçš„å¿…è¦æ€§
- [ ] æŒæ¡ isValidSignature æ¥å£
- [ ] ä¼šå®ç° EIP-1271
- [ ] çŸ¥é“å®é™…åº”ç”¨

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [EIP-1271 å®˜æ–¹æ–‡æ¡£](https://eips.ethereum.org/EIPS/eip-1271)
- [OpenZeppelin SignatureChecker](https://docs.openzeppelin.com/contracts/4.x/api/utils#SignatureChecker)

