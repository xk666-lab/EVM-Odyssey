# EIP-4337 è´¦æˆ·æŠ½è±¡

> ğŸ“ å¾…ç¼–å†™

## å­¦ä¹ ç›®æ ‡

- ç†è§£è´¦æˆ·æŠ½è±¡çš„æ¦‚å¿µ
- æŒæ¡ UserOperation çš„ç»“æ„
- äº†è§£ EntryPoint å’Œ Paymaster
- ç†è§£æ™ºèƒ½è´¦æˆ·çš„æœªæ¥

## å¤§çº²

### 1. ä»€ä¹ˆæ˜¯è´¦æˆ·æŠ½è±¡ï¼Ÿ

#### 1.1 ä¼ ç»Ÿè´¦æˆ·çš„å±€é™
- EOAï¼ˆå¤–éƒ¨è´¦æˆ·ï¼‰åŠŸèƒ½å•ä¸€
- åªèƒ½ç”¨ç§é’¥ç­¾å
- æ— æ³•å®ç°å¤æ‚é€»è¾‘
- å¿…é¡»æŒæœ‰ ETH æ”¯ä»˜ Gas

#### 1.2 æ™ºèƒ½è´¦æˆ·çš„ä¼˜åŠ¿
- å¯ç¼–ç¨‹çš„è´¦æˆ·é€»è¾‘
- å¤šç­¾ã€ç¤¾äº¤æ¢å¤
- Gas ä»£ä»˜ï¼ˆPaymasterï¼‰
- æ‰¹é‡æ“ä½œ
- è‡ªå®šä¹‰ç­¾åéªŒè¯

### 2. EIP-4337 æ¶æ„

```
ç”¨æˆ· â†’ UserOperation â†’ Bundler â†’ EntryPoint â†’ æ™ºèƒ½è´¦æˆ·
                                       â†“
                                   Paymaster
                                  (å¯é€‰Gasä»£ä»˜)
```

### 3. æ ¸å¿ƒç»„ä»¶

#### 3.1 UserOperation
```solidity
struct UserOperation {
    address sender;              // æ™ºèƒ½è´¦æˆ·åœ°å€
    uint256 nonce;
    bytes initCode;             // è´¦æˆ·éƒ¨ç½²ä»£ç ï¼ˆå¦‚æœæœªéƒ¨ç½²ï¼‰
    bytes callData;             // è¦æ‰§è¡Œçš„æ“ä½œ
    uint256 callGasLimit;
    uint256 verificationGasLimit;
    uint256 preVerificationGas;
    uint256 maxFeePerGas;
    uint256 maxPriorityFeePerGas;
    bytes paymasterAndData;     // Paymaster ä¿¡æ¯
    bytes signature;            // ç”¨æˆ·ç­¾å
}
```

#### 3.2 EntryPoint
- æ ¸å¿ƒå…¥å£åˆçº¦
- éªŒè¯å’Œæ‰§è¡Œ UserOperation
- åè°ƒå„ç»„ä»¶

#### 3.3 Smart Accountï¼ˆæ™ºèƒ½è´¦æˆ·ï¼‰
```solidity
interface IAccount {
    function validateUserOp(
        UserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 missingAccountFunds
    ) external returns (uint256 validationData);
}
```

#### 3.4 Paymaster
```solidity
interface IPaymaster {
    function validatePaymasterUserOp(
        UserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 maxCost
    ) external returns (bytes memory context, uint256 validationData);
}
```

#### 3.5 Bundler
- æ”¶é›† UserOperations
- æ‰“åŒ…æäº¤åˆ° EntryPoint
- çŸ¿å·¥/éªŒè¯è€…è§’è‰²

### 4. å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·åˆ›å»º UserOperation
2. ç­¾å UserOperation
3. å‘é€ç»™ Bundler
4. Bundler éªŒè¯å¹¶æ‰“åŒ…
5. æäº¤åˆ° EntryPoint
6. EntryPoint éªŒè¯ï¼š
   - è°ƒç”¨è´¦æˆ·çš„ validateUserOp
   - å¦‚æœæœ‰ Paymasterï¼Œè°ƒç”¨å…¶éªŒè¯
7. æ‰§è¡Œæ“ä½œ
8. æ”¯ä»˜ Gasï¼ˆè´¦æˆ·æˆ– Paymasterï¼‰
```

### 5. åº”ç”¨åœºæ™¯

#### 5.1 ç¤¾äº¤æ¢å¤
```solidity
contract SocialRecoveryAccount {
    mapping(address => bool) public guardians;
    
    function recover(address newOwner, bytes[] calldata signatures) external {
        // éªŒè¯å¤šä¸ª guardian ç­¾å
        // æ›´æ¢è´¦æˆ·æ‰€æœ‰è€…
    }
}
```

#### 5.2 å¤šç­¾è´¦æˆ·
```solidity
contract MultiSigAccount {
    function validateUserOp(...) external returns (uint256) {
        // éªŒè¯éœ€è¦ N ä¸ªç­¾å
    }
}
```

#### 5.3 Gas ä»£ä»˜
```solidity
contract SponsorPaymaster is IPaymaster {
    function validatePaymasterUserOp(...) external returns (...) {
        // ä¸ºç‰¹å®šç”¨æˆ·ä»£ä»˜ Gas
        // æˆ–ä¸ºç‰¹å®šæ“ä½œä»£ä»˜ Gas
    }
}
```

#### 5.4 æ‰¹é‡æ“ä½œ
```solidity
UserOperation {
    callData: [
        transfer(A, 100),
        transfer(B, 200),
        approve(C, 300)
    ]
}
```

### 6. å®ç°ç¤ºä¾‹

#### 6.1 ç®€å•æ™ºèƒ½è´¦æˆ·
```solidity
contract SimpleAccount is IAccount {
    address public owner;
    
    function validateUserOp(
        UserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 missingAccountFunds
    ) external returns (uint256 validationData) {
        // 1. éªŒè¯ç­¾å
        bytes32 hash = userOpHash.toEthSignedMessageHash();
        address signer = hash.recover(userOp.signature);
        
        if (signer != owner) {
            return SIG_VALIDATION_FAILED;
        }
        
        // 2. æ”¯ä»˜ Gasï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (missingAccountFunds > 0) {
            (bool success,) = payable(msg.sender).call{value: missingAccountFunds}("");
            require(success);
        }
        
        return 0;  // éªŒè¯æˆåŠŸ
    }
    
    function execute(address dest, uint256 value, bytes calldata func) external {
        require(msg.sender == address(entryPoint), "Only EntryPoint");
        (bool success, bytes memory result) = dest.call{value: value}(func);
        if (!success) {
            assembly {
                revert(add(result, 32), mload(result))
            }
        }
    }
}
```

#### 6.2 ç®€å• Paymaster
```solidity
contract SponsorPaymaster is IPaymaster {
    mapping(address => bool) public sponsors;
    
    function validatePaymasterUserOp(
        UserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 maxCost
    ) external returns (bytes memory context, uint256 validationData) {
        // éªŒè¯æ˜¯å¦åº”è¯¥èµåŠ©
        if (!sponsors[userOp.sender]) {
            return ("", SIG_VALIDATION_FAILED);
        }
        
        return ("", 0);
    }
    
    function postOp(
        PostOpMode mode,
        bytes calldata context,
        uint256 actualGasCost
    ) external {
        // Gas æ”¯ä»˜åçš„å¤„ç†
    }
}
```

### 7. ç°æœ‰é¡¹ç›®

#### 7.1 ä¸»è¦å®ç°
- **Safe (Gnosis Safe)**ï¼šå¤šç­¾æ™ºèƒ½è´¦æˆ·
- **Argent**ï¼šç§»åŠ¨ç«¯æ™ºèƒ½é’±åŒ…
- **Biconomy**ï¼šè´¦æˆ·æŠ½è±¡åŸºç¡€è®¾æ–½
- **StackUp**ï¼šBundler æœåŠ¡
- **Alchemy Account Kit**ï¼šå¼€å‘å·¥å…·åŒ…

#### 7.2 å‘å±•çŠ¶æ€
- 2023 å¹´ 3 æœˆä¸»ç½‘éƒ¨ç½²
- EntryPoint v0.6
- ç”Ÿæ€å¿«é€Ÿå‘å±•

### 8. å®‰å…¨è€ƒè™‘

#### 8.1 ç­¾åéªŒè¯
```solidity
// âœ… æ­£ç¡®ï¼šéªŒè¯ç­¾å
address signer = hash.recover(signature);
require(signer == owner, "Invalid signature");

// âŒ é”™è¯¯ï¼šè·³è¿‡éªŒè¯
// ä»»ä½•äººéƒ½å¯ä»¥æ“ä½œè´¦æˆ·
```

#### 8.2 é‡æ”¾æ”»å‡»
```solidity
// âœ… ä½¿ç”¨ nonce
uint256 currentNonce = nonces[userOp.sender];
require(userOp.nonce == currentNonce, "Invalid nonce");
nonces[userOp.sender]++;
```

#### 8.3 Gas é™åˆ¶
```solidity
// é˜²æ­¢ Gas è€—å°½
require(gasleft() >= userOp.callGasLimit, "Insufficient gas");
```

### 9. ä¸ä¼ ç»Ÿè´¦æˆ·çš„å¯¹æ¯”

| ç‰¹æ€§ | EOA | æ™ºèƒ½è´¦æˆ· (EIP-4337) |
|------|-----|---------------------|
| ç­¾åæ–¹å¼ | å›ºå®šï¼ˆECDSAï¼‰ | å¯è‡ªå®šä¹‰ |
| æ¢å¤æœºåˆ¶ | æ—  | ç¤¾äº¤æ¢å¤/å¤šç­¾ |
| Gas æ”¯ä»˜ | å¿…é¡»æŒæœ‰ ETH | Paymaster ä»£ä»˜ |
| æ‰¹é‡æ“ä½œ | ä¸æ”¯æŒ | æ”¯æŒ |
| éƒ¨ç½²æˆæœ¬ | æ—  | æœ‰ï¼ˆä½†å¯å»¶è¿Ÿï¼‰ |
| å¤æ‚æ€§ | ç®€å• | å¤æ‚ |

### 10. å‰ç«¯é›†æˆ

```javascript
// ä½¿ç”¨ Alchemy Account Kit
import { AlchemyProvider } from "@alchemy/aa-alchemy";
import { LightSmartContractAccount } from "@alchemy/aa-accounts";

const provider = new AlchemyProvider({
  apiKey: "YOUR_API_KEY",
  chain: mainnet,
});

const account = new LightSmartContractAccount({
  chain: mainnet,
  owner: signer,
  entryPointAddress: ENTRY_POINT_ADDRESS,
  factoryAddress: FACTORY_ADDRESS,
});

// å‘é€ UserOperation
const result = await provider.sendUserOperation({
  target: targetAddress,
  data: encodedData,
  value: 0n,
});
```

### 11. å®æˆ˜ç»ƒä¹ 

#### ç»ƒä¹  1ï¼šå®ç°ç®€å•æ™ºèƒ½è´¦æˆ·
1. å®ç° validateUserOp
2. å®ç° execute å‡½æ•°
3. æµ‹è¯•ç­¾åéªŒè¯

#### ç»ƒä¹  2ï¼šå®ç° Paymaster
1. åˆ›å»ºèµåŠ©åˆ—è¡¨
2. å®ç°éªŒè¯é€»è¾‘
3. æµ‹è¯• Gas ä»£ä»˜

#### ç»ƒä¹  3ï¼šä½¿ç”¨ SDK
1. é›†æˆ Alchemy Account Kit
2. åˆ›å»ºæ™ºèƒ½è´¦æˆ·
3. å‘é€ UserOperation

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] ç†è§£è´¦æˆ·æŠ½è±¡çš„æ¦‚å¿µ
- [ ] æŒæ¡ UserOperation ç»“æ„
- [ ] ç†è§£ EntryPoint çš„ä½œç”¨
- [ ] ç†è§£ Paymaster æœºåˆ¶
- [ ] çŸ¥é“å®é™…åº”ç”¨åœºæ™¯
- [ ] äº†è§£ç°æœ‰é¡¹ç›®
- [ ] ç†è§£å®‰å…¨æ³¨æ„äº‹é¡¹

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [EIP-4337 å®˜æ–¹æ–‡æ¡£](https://eips.ethereum.org/EIPS/eip-4337)
- [Account Abstraction å®˜æ–¹ç½‘ç«™](https://www.erc4337.io/)
- [Alchemy Account Kit](https://docs.alchemy.com/docs/account-kit-overview)
- [Safe Core Protocol](https://docs.safe.global/safe-smart-account/account-abstraction)
- [Biconomy SDK](https://docs.biconomy.io/)

