# EIP-712 ç»“æž„åŒ–æ•°æ®ç­¾å

> ðŸ“ å¾…ç¼–å†™

## å­¦ä¹ ç›®æ ‡

- ç†è§£ EIP-712 çš„è®¾è®¡åŠ¨æœº
- æŽŒæ¡ Domain Separator çš„ä½œç”¨
- å­¦ä¼šå®žçŽ° EIP-712 ç­¾åéªŒè¯
- **ç†è§£ä½ çš„ eip712.sol ä»£ç **

## å¤§çº²

### 1. ä¸ºä»€ä¹ˆéœ€è¦ EIP-712ï¼Ÿ

#### 1.1 ä¼ ç»Ÿç­¾åçš„é—®é¢˜
```solidity
// ç®€å•çš„ç­¾åï¼šä¸å®‰å…¨
bytes32 hash = keccak256(abi.encodePacked(to, amount));
address signer = ecrecover(hash, v, r, s);
```

#### 1.2 å®‰å…¨éšæ‚£
- é‡æ”¾æ”»å‡»
- è·¨é“¾é‡æ”¾
- è·¨åˆçº¦é‡æ”¾
- ç”¨æˆ·çœ‹ä¸æ‡‚ç­¾åå†…å®¹

#### 1.3 EIP-712 çš„è§£å†³æ–¹æ¡ˆ
- ç»“æž„åŒ–æ•°æ®
- Domain Separatorï¼ˆé˜²é‡æ”¾ï¼‰
- äººç±»å¯è¯»çš„ç­¾åå†…å®¹

### 2. EIP-712 æ ¸å¿ƒæ¦‚å¿µ

#### 2.1 Domain Separator
```solidity
bytes32 DOMAIN_SEPARATOR = keccak256(abi.encode(
    keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
    keccak256(bytes(name)),
    keccak256(bytes(version)),
    block.chainid,
    address(this)
));
```

ä½œç”¨ï¼š
- ç»‘å®šåˆ°ç‰¹å®šåˆçº¦
- ç»‘å®šåˆ°ç‰¹å®šé“¾
- é˜²æ­¢è·¨é“¾/è·¨åˆçº¦é‡æ”¾

#### 2.2 ç±»åž‹å“ˆå¸Œï¼ˆTypeHashï¼‰
```solidity
bytes32 PERMIT_TYPEHASH = keccak256(
    "Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"
);
```

#### 2.3 ç»“æž„ä½“å“ˆå¸Œ
```solidity
bytes32 structHash = keccak256(abi.encode(
    PERMIT_TYPEHASH,
    owner,
    spender,
    value,
    nonce,
    deadline
));
```

#### 2.4 æœ€ç»ˆå“ˆå¸Œ
```solidity
bytes32 digest = keccak256(abi.encodePacked(
    "\x19\x01",  // EIP-712 magic value
    DOMAIN_SEPARATOR,
    structHash
));
```

### 3. å®Œæ•´å®žçŽ°ç¤ºä¾‹

```solidity
contract EIP712Example {
    bytes32 private immutable DOMAIN_SEPARATOR;
    bytes32 private constant PERMIT_TYPEHASH = keccak256(
        "Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"
    );
    
    mapping(address => uint256) public nonces;
    
    constructor() {
        DOMAIN_SEPARATOR = keccak256(abi.encode(
            keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
            keccak256(bytes("MyToken")),
            keccak256(bytes("1")),
            block.chainid,
            address(this)
        ));
    }
    
    function permit(
        address owner,
        address spender,
        uint256 value,
        uint256 deadline,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external {
        require(block.timestamp <= deadline, "Expired");
        
        bytes32 structHash = keccak256(abi.encode(
            PERMIT_TYPEHASH,
            owner,
            spender,
            value,
            nonces[owner]++,
            deadline
        ));
        
        bytes32 digest = keccak256(abi.encodePacked(
            "\x19\x01",
            DOMAIN_SEPARATOR,
            structHash
        ));
        
        address signer = ecrecover(digest, v, r, s);
        require(signer == owner, "Invalid signature");
        
        // æ‰§è¡ŒæŽˆæƒé€»è¾‘
        _approve(owner, spender, value);
    }
}
```

### 4. å‰ç«¯ç­¾åï¼ˆethers.jsï¼‰

```javascript
const domain = {
  name: 'MyToken',
  version: '1',
  chainId: 1,
  verifyingContract: tokenAddress
};

const types = {
  Permit: [
    { name: 'owner', type: 'address' },
    { name: 'spender', type: 'address' },
    { name: 'value', type: 'uint256' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' }
  ]
};

const value = {
  owner: ownerAddress,
  spender: spenderAddress,
  value: amount,
  nonce: nonce,
  deadline: deadline
};

const signature = await signer._signTypedData(domain, types, value);
const { v, r, s } = ethers.utils.splitSignature(signature);
```

### 5. ç†è§£ä½ çš„ eip712.sol

ä½ å½“å‰æ‰“å¼€çš„æ–‡ä»¶ `eip712.sol` åº”è¯¥åŒ…å«ï¼š
- Domain Separator çš„æž„å»º
- ç±»åž‹å“ˆå¸Œçš„å®šä¹‰
- ç­¾åéªŒè¯é€»è¾‘

**çŽ°åœ¨ä½ åº”è¯¥èƒ½ç†è§£æ¯ä¸€è¡Œä»£ç äº†ï¼**

### 6. å®žé™…åº”ç”¨åœºæ™¯

#### 6.1 Permitï¼ˆEIP-2612ï¼‰
- Gasless approval
- ç”¨æˆ·ç­¾åï¼Œç¬¬ä¸‰æ–¹æäº¤

#### 6.2 å…ƒäº¤æ˜“ï¼ˆMeta Transactionï¼‰
- ç”¨æˆ·ç­¾åäº¤æ˜“
- Relayer ä»£ä»˜ Gas

#### 6.3 æŠ•ç¥¨
- é“¾ä¸‹ç­¾åæŠ•ç¥¨
- èŠ‚çœ Gas

#### 6.4 è®¢å•ç°¿
- Uniswap X
- é“¾ä¸‹è®¢å•ï¼Œé“¾ä¸Šç»“ç®—

### 7. å®‰å…¨è€ƒè™‘

#### 7.1 Nonce ç®¡ç†
- é˜²æ­¢é‡æ”¾æ”»å‡»
- æ¯æ¬¡ä½¿ç”¨åŽé€’å¢ž

#### 7.2 Deadline æœºåˆ¶
- ç­¾åæœ‰æ•ˆæœŸ
- é˜²æ­¢è¿‡æœŸç­¾åè¢«ä½¿ç”¨

#### 7.3 Domain Separator
- å¿…é¡»åŒ…å« chainId
- å¿…é¡»åŒ…å«åˆçº¦åœ°å€

### 8. OpenZeppelin çš„å®žçŽ°

```solidity
import "@openzeppelin/contracts/utils/cryptography/EIP712.sol";

contract MyContract is EIP712 {
    constructor() EIP712("MyContract", "1") {}
    
    function _hashTypedDataV4(bytes32 structHash) internal view returns (bytes32) {
        return super._hashTypedDataV4(structHash);
    }
}
```

### 9. å®žæˆ˜ç»ƒä¹ 

#### ç»ƒä¹  1ï¼šå®žçŽ°ç®€å•çš„ Permit
1. åˆ›å»º ERC-20 ä»£å¸
2. æ·»åŠ  EIP-712 æ”¯æŒ
3. å®žçŽ° permit å‡½æ•°

#### ç»ƒä¹  2ï¼šå‰ç«¯é›†æˆ
1. ä½¿ç”¨ ethers.js ç”Ÿæˆç­¾å
2. è°ƒç”¨åˆçº¦éªŒè¯ç­¾å
3. æµ‹è¯•å®Œæ•´æµç¨‹

#### ç»ƒä¹  3ï¼šé˜…è¯»ä½ çš„ä»£ç 
1. æ‰“å¼€ä½ çš„ eip712.sol
2. è¯†åˆ« Domain Separator
3. è¯†åˆ«ç±»åž‹å“ˆå¸Œ
4. ç†è§£ç­¾åéªŒè¯é€»è¾‘

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ EIP-712 çš„å¿…è¦æ€§
- [ ] æŽŒæ¡ Domain Separator
- [ ] ç†è§£ç±»åž‹å“ˆå¸Œ
- [ ] ä¼šå®žçŽ°ç­¾åéªŒè¯
- [ ] ç†è§£ä½ çš„ eip712.sol ä»£ç 
- [ ] çŸ¥é“å®žé™…åº”ç”¨åœºæ™¯
- [ ] äº†è§£å®‰å…¨æ³¨æ„äº‹é¡¹

---

## ðŸ“š å‚è€ƒèµ„æ–™

- [EIP-712 å®˜æ–¹æ–‡æ¡£](https://eips.ethereum.org/EIPS/eip-712)
- [OpenZeppelin EIP712 å®žçŽ°](https://docs.openzeppelin.com/contracts/4.x/api/utils#EIP712)
- [ethers.js ç­¾åæ–‡æ¡£](https://docs.ethers.org/v5/api/signer/#Signer-signTypedData)

