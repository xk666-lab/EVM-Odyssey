# 恒定乘积公式完整推导 (Constant Product Formula)

> 💡 **核心要点**
> - x * y = k 是Uniswap的核心
> - 这是一个双曲线方程
> - 价格是曲线的斜率
> - 手推公式能让你真正理解AMM

---

## 📚 目录

1. [基础概念回顾](#1-基础概念回顾)
2. [恒定乘积公式推导](#2-恒定乘积公式推导)
3. [价格公式推导](#3-价格公式推导)
4. [输出金额计算](#4-输出金额计算)
5. [输入金额计算](#5-输入金额计算)
6. [考虑手续费的完整公式](#6-考虑手续费的完整公式)
7. [实例验证](#7-实例验证)

---

## 1. 基础概念回顾

### 1.1 流动性池设定

假设有一个ETH/USDC流动性池：

```
x = ETH的数量
y = USDC的数量
k = 常数（储备量乘积）
```

### 1.2 核心不变量

**恒定乘积公式：**

```
x · y = k
```

**含义**：无论如何交易，两种代币储备量的乘积保持不变。

---

## 2. 恒定乘积公式推导

### 2.1 为什么选择x · y = k？

让我们从需求出发推导这个公式。

#### 需求1：永远有流动性

我们希望无论买多少，池子永远不会耗尽：

```
当 x → 0 时，y → ∞
当 y → 0 时，x → ∞
```

#### 需求2：价格随供需变化

- 买的人多 → 价格上涨
- 卖的人多 → 价格下跌

#### 需求3：数学上简单

- 计算gas费低
- 容易理解
- 可预测

### 2.2 数学推导

从微观经济学的**边际价格**出发：

#### 定义价格

价格 P 定义为：用多少y能换1单位x

```
P = dy/dx
```

#### 设定价格变化规律

假设价格与储备量成正比：

```
P ∝ y/x
```

即：

```
P = k' · y/x
```

其中k'是某个常数。

#### 积分求解

```
dy/dx = k' · y/x

∫(1/y)dy = ∫(k'/x)dx

ln(y) = k' · ln(x) + C

ln(y) = ln(x^k') + C

y = e^C · x^k'
```

**特殊情况**：当k' = 1时：

```
y = e^C · x

x · y = e^C = 常数 = k
```

这就推导出了 **x · y = k**！

### 2.3 几何理解

`x · y = k` 是一条**等轴双曲线**：

```
y = k/x

USDC (y)
    ↑
    │     
 4k │  ●
    │    ╲
 3k │     ●
    │      ╲
 2k │       ●
    │         ╲
  k │           ●
    │             ╲___●___
    └────────────────────→ ETH (x)
    0   k   2k  3k  4k

性质：
1. 渐近线：x=0, y=0
2. 对称性：关于y=x对称
3. 凸函数：二阶导数>0
```

---

## 3. 价格公式推导

### 3.1 即时价格（Spot Price）

价格定义为边际兑换率：

```
P = dy/dx
```

对 `x · y = k` 两边对x求导：

```
d(x · y)/dx = dk/dx = 0

y + x · dy/dx = 0

dy/dx = -y/x
```

**即时价格公式：**

```
P = y/x
```

**含义**：在某个时刻，1个ETH的价格 = 池中USDC数量/池中ETH数量

### 3.2 实例

**池子状态：**
- x = 100 ETH
- y = 200,000 USDC

**即时价格：**

```
P = 200,000 / 100 = 2,000 USDC/ETH
```

### 3.3 价格随储备变化

当有人买入ETH（x减少，y增加）：

```
P_new = y_new / x_new

因为 x_new < x_old，y_new > y_old
所以 P_new > P_old
```

**价格上涨！**

---

## 4. 输出金额计算

### 4.1 问题设定

**已知**：
- 当前储备：x, y
- 输入金额：Δy (USDC)

**求**：能换到多少 Δx (ETH)？

### 4.2 推导过程

**交易前：**
```
x₀ · y₀ = k
```

**交易后：**
```
(x₀ - Δx) · (y₀ + Δy) = k
```

**因为 k 不变：**

```
(x₀ - Δx) · (y₀ + Δy) = x₀ · y₀

展开：
x₀·y₀ + x₀·Δy - Δx·y₀ - Δx·Δy = x₀·y₀

消去 x₀·y₀：
x₀·Δy - Δx·y₀ - Δx·Δy = 0

移项：
x₀·Δy = Δx·y₀ + Δx·Δy

提取 Δx：
x₀·Δy = Δx·(y₀ + Δy)
```

**输出金额公式：**

```
Δx = (x₀ · Δy) / (y₀ + Δy)
```

### 4.3 实例计算

**池子：**
- x₀ = 100 ETH
- y₀ = 200,000 USDC

**输入：**
- Δy = 10,000 USDC

**计算：**

```
Δx = (100 · 10,000) / (200,000 + 10,000)
   = 1,000,000 / 210,000
   = 4.762 ETH
```

**验证：**

```
交易前：100 · 200,000 = 20,000,000
交易后：95.238 · 210,000 = 19,999,980 ≈ 20,000,000 ✓
```

(细微差异是因为小数舍入)

### 4.4 平均价格

```
平均价格 = Δy / Δx
         = 10,000 / 4.762
         = 2,100 USDC/ETH
```

注意：高于初始即时价格2,000！这就是**价格影响**。

---

## 5. 输入金额计算

### 5.1 问题设定

**已知**：
- 当前储备：x, y
- 期望输出：Δx (想买4 ETH)

**求**：需要支付多少 Δy (USDC)？

### 5.2 推导过程

从前面的公式：

```
Δx = (x₀ · Δy) / (y₀ + Δy)
```

反解 Δy：

```
Δx · (y₀ + Δy) = x₀ · Δy

Δx · y₀ + Δx · Δy = x₀ · Δy

Δx · y₀ = x₀ · Δy - Δx · Δy

Δx · y₀ = Δy · (x₀ - Δx)
```

**输入金额公式：**

```
Δy = (Δx · y₀) / (x₀ - Δx)
```

### 5.3 实例计算

**池子：**
- x₀ = 100 ETH
- y₀ = 200,000 USDC

**期望输出：**
- Δx = 10 ETH

**计算：**

```
Δy = (10 · 200,000) / (100 - 10)
   = 2,000,000 / 90
   = 22,222.22 USDC
```

**验证：**

```
新状态：90 ETH, 222,222.22 USDC
k = 90 · 222,222.22 = 20,000,000 ✓
```

---

## 6. 考虑手续费的完整公式

### 6.1 Uniswap V2手续费

Uniswap收取**0.3%**的手续费：

- 实际进入池子的只有 99.7%
- 0.3% 分给LP

### 6.2 修正后的输出公式

```
不考虑手续费：
Δx = (x₀ · Δy) / (y₀ + Δy)

考虑0.3%手续费：
Δx = (x₀ · Δy · 0.997) / (y₀ + Δy · 0.997)
```

更通用的公式（手续费率为f）：

```
Δx = (x₀ · Δy · (1-f)) / (y₀ + Δy · (1-f))

其中 f = 0.003 (0.3%)
```

### 6.3 手续费影响示例

**池子：**
- x₀ = 100 ETH
- y₀ = 200,000 USDC

**输入：**
- Δy = 10,000 USDC

**不考虑手续费：**
```
Δx = (100 · 10,000) / (200,000 + 10,000)
   = 4.762 ETH
```

**考虑0.3%手续费：**
```
Δx = (100 · 10,000 · 0.997) / (200,000 + 10,000 · 0.997)
   = 997,000 / 209,970
   = 4.748 ETH
```

**手续费导致的差额：**
```
4.762 - 4.748 = 0.014 ETH
价值约 28 USDC
```

---

## 7. 实例验证

### 7.1 完整交易模拟

**初始状态：**
```
x₀ = 100 ETH
y₀ = 200,000 USDC
k = 20,000,000
P₀ = 2,000 USDC/ETH
```

**交易1：买入**

Alice用20,000 USDC买ETH（含手续费）：

```
Δy = 20,000
Δx = (100 · 20,000 · 0.997) / (200,000 + 20,000 · 0.997)
   = 1,994,000 / 219,940
   = 9.066 ETH

新状态：
x₁ = 100 - 9.066 = 90.934 ETH
y₁ = 200,000 + 20,000 = 220,000 USDC
k₁ = 90.934 · 220,000 = 20,005,480

价格：
P₁ = 220,000 / 90.934 = 2,419 USDC/ETH
```

**价格上涨：**
```
涨幅 = (2,419 - 2,000) / 2,000 = 20.95%
```

**交易2：卖出**

Bob卖出5 ETH（含手续费）：

```
Δx = 5
Δy = (5 · 220,000 · 0.997) / (90.934 - 5)
   = 1,096,700 / 85.934
   = 12,761 USDC

新状态：
x₂ = 90.934 + 5 = 95.934 ETH
y₂ = 220,000 - 12,761 = 207,239 USDC
k₂ = 95.934 · 207,239 = 19,880,686

价格：
P₂ = 207,239 / 95.934 = 2,160 USDC/ETH
```

### 7.2 价格曲线可视化

```
价格 (USDC/ETH)
    ↑
3000│           ●  (交易后)
    │         ╱
2419│        ● P₁
    │      ╱
2160│     ● P₂
2000│    ● P₀ (初始)
    │   ╱
1500│  ╱
    │ ╱
1000│●
    └───────────────→ ETH储备量
    80  90  100 110
```

---

## 🧮 练习题

### 练习1：基础计算

池子：50 ETH, 100,000 USDC

用5,000 USDC买ETH（不考虑手续费），能买多少？

<details>
<summary>点击查看答案</summary>

```
Δx = (50 · 5,000) / (100,000 + 5,000)
   = 250,000 / 105,000
   = 2.381 ETH

验证：
k = 50 · 100,000 = 5,000,000
新k = 47.619 · 105,000 = 4,999,995 ≈ 5,000,000 ✓
```
</details>

### 练习2：反向计算

同样的池子，我想买3个ETH，需要多少USDC？

### 练习3：手续费影响

考虑0.3%手续费，重新计算练习1。

### 练习4：价格影响

计算练习1中的：
- 即时价格
- 平均价格
- 价格影响百分比

---

## 📊 公式总结

### 核心公式

```
1. 恒定乘积：
   x · y = k

2. 即时价格：
   P = y / x

3. 输出金额（不含手续费）：
   Δx = (x₀ · Δy) / (y₀ + Δy)

4. 输出金额（含手续费）：
   Δx = (x₀ · Δy · 0.997) / (y₀ + Δy · 0.997)

5. 输入金额：
   Δy = (Δx · y₀) / (x₀ - Δx)

6. 价格影响：
   Price Impact = (P_new - P_old) / P_old
```

---

## 📚 延伸阅读

### 数学背景
- [双曲线性质](https://zh.wikipedia.org/wiki/双曲线)
- [边际分析](https://zh.wikipedia.org/wiki/边际分析)

### 代码实现
- [Uniswap V2 Core - UniswapV2Pair.sol](https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol)

```solidity
// Uniswap V2 核心代码
function getAmountOut(
    uint amountIn,
    uint reserveIn,
    uint reserveOut
) internal pure returns (uint amountOut) {
    uint amountInWithFee = amountIn.mul(997);
    uint numerator = amountInWithFee.mul(reserveOut);
    uint denominator = reserveIn.mul(1000).add(amountInWithFee);
    amountOut = numerator / denominator;
}
```

---

## ✅ 学习检查清单

完成本章后，你应该能够：

- [ ] 理解为什么选择x·y=k
- [ ] 能推导出价格公式 P=y/x
- [ ] 能手算输出金额
- [ ] 能手算输入金额
- [ ] 理解手续费如何影响计算
- [ ] 能解释价格影响
- [ ] 看懂Uniswap V2的核心代码

---

## 🎯 下一步

掌握了数学推导后，继续学习：

1. ✅ **无常损失详解** → 理解LP的风险
2. ✅ **滑点计算** → 计算价格影响
3. ✅ **Uniswap V2源码** → 看代码实现
4. ✅ **实操swap** → 实际交易体验

---

**记住**：
- 📐 **x·y=k是一切的基础**
- 🔢 **手推公式能加深理解**
- 💡 **价格=y/x（储备量比）**
- ⚠️ **手续费和价格影响都很重要**

恭喜你掌握了DeFi最核心的数学！🎉

准备好学习无常损失了吗？那是LP最需要理解的概念！🚀
