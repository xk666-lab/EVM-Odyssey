# AMM自动做市商 (Automated Market Maker)

> 💡 **核心要点**
> - AMM是DeFi的核心创新，颠覆了传统交易所模式
> - 使用数学公式自动定价，无需订单簿
> - 任何人都可以成为做市商，提供流动性赚取手续费
> - x * y = k 是最经典的恒定乘积公式

---

## 📚 目录

1. [传统交易所的问题](#1-传统交易所的问题)
2. [AMM是什么](#2-amm是什么)
3. [AMM工作原理](#3-amm工作原理)
4. [恒定乘积公式 x*y=k](#4-恒定乘积公式-xyk)
5. [实例演示](#5-实例演示)
6. [AMM的优势与劣势](#6-amm的优势与劣势)
7. [不同类型的AMM](#7-不同类型的amm)

---

## 1. 传统交易所的问题

### 1.1 订单簿模式（Order Book）

传统的中心化交易所（如币安、Coinbase）和去中心化交易所早期版本都使用**订单簿**模式：

```
买单（Buy Orders）          卖单（Sell Orders）
价格    数量                价格    数量
$99.5   10 ETH             $100.5  15 ETH
$99.0   20 ETH             $101.0  25 ETH
$98.5   30 ETH             $101.5  35 ETH
        ↓                         ↑
    买方出价                  卖方要价
```

#### 问题1：需要做市商

- 订单簿需要**专业做市商**在买卖两侧挂单
- 普通用户很难成为做市商
- 做市商掌握定价权

#### 问题2：流动性分散

- 流动性分散在不同价格档位
- 小币种流动性严重不足
- 容易被大额订单冲击

#### 问题3：Gas费问题

在链上实现订单簿：
- 每次挂单/撤单都需要gas
- 高频交易成本极高
- 用户体验差

---

## 2. AMM是什么？

### 2.1 核心概念

**AMM (Automated Market Maker)** = 自动做市商

- **不需要订单簿**
- **不需要买卖双方匹配**
- **使用数学公式自动定价**
- **任何人都可以提供流动性**

### 2.2 革命性创新

```
传统模式：
用户A想买 ←→ 必须找到 ←→ 用户B想卖
              (订单匹配)

AMM模式：
用户 ←→ 直接与流动性池交易 ←→ 数学公式自动定价
```

### 2.3 核心组件

#### 流动性池 (Liquidity Pool)

一个智能合约，里面存放着两种代币：

```
流动性池：ETH/USDC
┌─────────────────────┐
│   100 ETH           │
│   +                 │
│   200,000 USDC      │
└─────────────────────┘
```

#### 流动性提供者 (Liquidity Provider, LP)

任何人都可以向池子里存入代币，成为LP：
- 赚取交易手续费
- 承担无常损失风险

#### 交易者 (Trader)

直接与流动性池交易：
- 不需要等待对手方
- 立即成交
- 价格由公式自动计算

---

## 3. AMM工作原理

### 3.1 核心机制

#### 步骤1：创建流动性池

Alice创建ETH/USDC池，存入：
- 100 ETH
- 200,000 USDC

初始价格：1 ETH = 2000 USDC

#### 步骤2：其他LP加入

Bob也想提供流动性，按当前比例存入：
- 10 ETH
- 20,000 USDC

现在池子里有：
- 110 ETH
- 220,000 USDC

#### 步骤3：用户交易

Charlie想买10 ETH，他需要支付多少USDC？

**这里就是AMM的核心！不是简单的 10 * 2000 = 20,000 USDC**

而是由数学公式计算...

---

## 4. 恒定乘积公式 x*y=k

### 4.1 Uniswap的核心公式

```
x * y = k

x = ETH数量
y = USDC数量
k = 常数
```

#### 核心原理

**无论怎么交易，x * y 的乘积必须保持不变！**

### 4.2 为什么这个公式有效？

让我们用实例理解：

#### 初始状态

```
ETH = 100
USDC = 200,000
k = 100 * 200,000 = 20,000,000
```

#### 有人买入ETH

假设Charlie用USDC买ETH：

1. 他往池子里**加入USDC**
2. 从池子里**取走ETH**
3. 必须保证：新的ETH * 新的USDC = 20,000,000

#### 计算过程

Charlie想买10 ETH：

**交易前：**
- ETH = 100
- USDC = 200,000
- k = 20,000,000

**交易后：**
- ETH = 100 - 10 = 90
- USDC = ?
- k = 20,000,000

根据 `90 * USDC = 20,000,000`：

```
USDC = 20,000,000 / 90 = 222,222.22
```

**Charlie需要支付：**
```
222,222.22 - 200,000 = 22,222.22 USDC
```

**实际价格：**
```
22,222.22 / 10 = 2,222.22 USDC/ETH
```

⚠️ **注意**：虽然初始价格是2000，但买了10个后实际平均价格是2222！

这就是**价格滑点**的来源。

### 4.3 价格计算公式

对于输入金额 `Δy`（USDC），能买到多少 `Δx`（ETH）？

```
(x - Δx) * (y + Δy) = x * y

Δx = x * Δy / (y + Δy)
```

更准确的公式（考虑0.3%手续费）：

```
Δx = (x * Δy * 0.997) / (y + Δy * 0.997)
```

---

## 5. 实例演示

### 5.1 完整交易示例

**初始池子：**
- 100 ETH
- 200,000 USDC
- k = 20,000,000
- 初始价格：2000 USDC/ETH

#### 场景1：小额买入

Bob用1000 USDC买ETH：

```
Δy = 1000 USDC
Δx = (100 * 1000) / (200,000 + 1000)
   = 100,000 / 201,000
   = 0.4975 ETH

实际价格 = 1000 / 0.4975 = 2010 USDC/ETH
滑点 = (2010 - 2000) / 2000 = 0.5%
```

#### 场景2：大额买入

Charlie用20,000 USDC买ETH：

```
Δy = 20,000 USDC
Δx = (100 * 20,000) / (200,000 + 20,000)
   = 2,000,000 / 220,000
   = 9.09 ETH

实际价格 = 20,000 / 9.09 = 2200 USDC/ETH
滑点 = (2200 - 2000) / 2000 = 10%
```

**结论：买的越多，滑点越大！**

### 5.2 价格曲线可视化

```
USDC数量 (y)
    ↑
250k│     ●  ← 初始点 (100 ETH, 200k USDC)
    │    ╱
200k│   ●   ← 买入后 (90 ETH, 222k USDC)
    │  ╱
150k│ ╱
    │╱
100k│
    │
    └──────────────────────→ ETH数量 (x)
    0   50   100  150  200

这是一条双曲线！x * y = k
```

---

## 6. AMM的优势与劣势

### ✅ 6.1 优势

#### 1. 永远有流动性

- 不管多小的币种
- 只要有池子，就能交易
- 不需要等待对手方

#### 2. 任何人都可以做LP

- 不需要专业知识
- 存入两种代币即可
- 赚取手续费

#### 3. 抗审查

- 完全链上
- 无需许可
- 不可关停

#### 4. 可组合性

- 可以被其他协议调用
- 闪电贷
- 套利机器人

### ❌ 6.2 劣势

#### 1. 价格滑点

- 大额交易滑点高
- 不适合大额交易
- 资金效率低

#### 2. 无常损失

- LP面临价格波动风险
- 可能亏损
- 详见下一章

#### 3. Gas费

- 链上交易需要gas
- 以太坊L1上很贵
- L2和其他链好一些

#### 4. MEV风险

- 三明治攻击
- 抢先交易
- 需要防护

---

## 7. 不同类型的AMM

### 7.1 恒定乘积 (Constant Product)

**公式**：`x * y = k`

**代表**：Uniswap V2

**特点**：
- ✅ 简单
- ✅ 永远有流动性
- ❌ 资金效率低
- ❌ 滑点大

**适用**：波动性资产（ETH/USDC）

### 7.2 恒定和 (Constant Sum)

**公式**：`x + y = k`

**特点**：
- ✅ 无滑点
- ❌ 流动性可能耗尽
- ❌ 容易被套利

**适用**：理论模型，实际很少用

### 7.3 混合曲线 (Hybrid)

**代表**：Curve

**公式**：混合恒定乘积和恒定和

```
当价格接近1:1时 → 接近恒定和（低滑点）
当价格偏离时 → 接近恒定乘积（防止耗尽）
```

**适用**：稳定币交易（USDC/USDT/DAI）

### 7.4 加权池 (Weighted Pool)

**代表**：Balancer

**公式**：`x^w1 * y^w2 = k`

**特点**：
- 可以设置不同权重
- 例如：80% ETH + 20% USDC
- 减少无常损失

### 7.5 集中流动性 (Concentrated Liquidity)

**代表**：Uniswap V3

**特点**：
- LP可以选择价格区间
- 资金效率提升数千倍
- 更复杂的管理

---

## 📊 对比总结

| AMM类型 | 公式 | 滑点 | 资金效率 | 适用场景 |
|---------|------|------|---------|---------|
| 恒定乘积 | x*y=k | 高 | 低 | 波动资产 |
| 恒定和 | x+y=k | 无 | 极低 | 理论 |
| 混合曲线 | 混合 | 极低 | 高 | 稳定币 |
| 加权池 | x^w*y^(1-w)=k | 中 | 中 | 单边暴露 |
| 集中流动性 | x*y=k(区间) | 低 | 极高 | 所有 |

---

## 🧮 实战练习

### 练习1：计算输出

池子：50 ETH, 100,000 USDC

问：用5000 USDC能买多少ETH？

<details>
<summary>点击查看答案</summary>

```
k = 50 * 100,000 = 5,000,000

新USDC = 100,000 + 5,000 = 105,000
新ETH = 5,000,000 / 105,000 = 47.619

买到ETH = 50 - 47.619 = 2.381 ETH

实际价格 = 5000 / 2.381 = 2100 USDC/ETH
初始价格 = 100,000 / 50 = 2000 USDC/ETH
滑点 = 5%
```
</details>

### 练习2：价格影响

同样的池子，如果用50,000 USDC买，滑点是多少？

### 练习3：反向计算

如果我想买5个ETH，需要支付多少USDC？

---

## 📚 学习资源

### 官方文档
- [Uniswap V2 Whitepaper](https://uniswap.org/whitepaper.pdf)
- [Curve Whitepaper](https://curve.fi/files/stableswap-paper.pdf)
- [Balancer Whitepaper](https://balancer.fi/whitepaper.pdf)

### 可视化工具
- [Uniswap V2 Calculator](https://www.desmos.com/calculator) - 画曲线
- [Revert Finance](https://revert.finance/) - LP模拟

### 视频教程
- [Smart Contract Programmer - AMM](https://www.youtube.com/watch?v=QNPyFs8Wybk)
- [Finematics - How do LIQUIDITY POOLS work?](https://www.youtube.com/watch?v=cizLhxSKrAc)

---

## ✅ 学习检查清单

完成本章后，你应该能够：

- [ ] 解释AMM与订单簿的区别
- [ ] 理解x*y=k的含义
- [ ] 手算简单的swap输出
- [ ] 理解为什么会有滑点
- [ ] 知道不同AMM的应用场景
- [ ] 理解LP如何赚取手续费
- [ ] 意识到无常损失的存在

---

## 🎯 下一步

掌握了AMM基础后，继续学习：

1. ✅ **恒定乘积公式完整推导** → `03-DeFi数学基础/02-AMM核心数学模型/`
2. ✅ **无常损失详解** → `02-核心概念/05-无常损失详解.md`
3. ✅ **AMM机制深入** → `04-AMM机制深入/`
4. ✅ **Uniswap V2实战** → `15.1-Uniswap V2完全解析/`

---

**记住**：
- 🎯 **x * y = k 是DeFi的灵魂公式**
- 💡 **AMM让每个人都能成为做市商**
- ⚠️ **大额交易注意滑点**
- 📈 **LP赚手续费但有无常损失**

祝你学习顺利！准备好深入数学推导了吗？🚀
