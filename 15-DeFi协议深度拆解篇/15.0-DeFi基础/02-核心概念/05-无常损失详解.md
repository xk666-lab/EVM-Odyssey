# 无常损失详解 (Impermanent Loss)

> 💡 **核心要点**
> - 无常损失是LP的最大风险
> - 价格变化越大，损失越大
> - 手续费可以抵消部分损失
> - 不是所有人都适合做LP

---

## 📚 目录

1. [什么是无常损失](#1-什么是无常损失)
2. [通俗解释](#2-通俗解释)
3. [数学推导](#3-数学推导)
4. [不同价格变动的损失](#4-不同价格变动的损失)
5. [手续费vs无常损失](#5-手续费vs无常损失)
6. [何时值得做LP](#6-何时值得做LP)
7. [减少无常损失的方法](#7-减少无常损失的方法)

---

## 1. 什么是无常损失？

### 1.1 官方定义

**无常损失 (Impermanent Loss, IL)**：是指相比于**单纯持有**两种代币，因为**提供流动性**而产生的价值损失。

### 1.2 为什么叫"无常"？

- 如果价格**回到初始水平**，损失会消失
- 所以称为"无常"（impermanent）
- 但如果价格永不回归，损失就是**永久**的

### 1.3 核心原因

AMM的x·y=k公式会**自动重新平衡**你的资产组合，这个再平衡过程在价格变动时会导致你的总价值低于单纯持有。

---

## 2. 通俗解释

### 2.1 生动的比喻

想象你有两个篮子：

**篮子A（单纯持有）：**
```
100 个苹果 + 100 个橙子
```

**篮子B（提供流动性）：**
```
100 个苹果 + 100 个橙子 (放入AMM池子)
```

**初始状态：**
- 苹果 = $1
- 橙子 = $1
- 两个篮子价值都是 $200

**价格变化：**
- 苹果涨到 $4
- 橙子还是 $1

**篮子A的价值：**
```
100 · $4 + 100 · $1 = $500
```

**篮子B的价值：**
```
AMM会自动卖出一些苹果换橙子，保持 x·y=k
最终你可能有：
50 个苹果 + 200 个橙子
= 50 · $4 + 200 · $1 = $400
```

**无常损失：**
```
$500 - $400 = $100
损失率 = $100 / $500 = 20%
```

### 2.2 核心原因

AMM在苹果涨价时，会**自动卖出**你的苹果换橙子，让你错过了上涨的收益！

---

## 3. 数学推导

### 3.1 设定

**初始状态：**
- 存入 x₀ 个代币A
- 存入 y₀ 个代币B
- 价格比 P₀ = y₀/x₀

**价格变化后：**
- 代币A价格变为原来的 **r 倍**
- 新价格比 P₁ = r · P₀

### 3.2 推导池中资产

因为 x·y = k 保持不变：

```
k = x₀ · y₀
```

价格变化后，池子会重新平衡：

```
P₁ = y₁ / x₁ = r · P₀ = r · (y₀/x₀)

所以：
y₁ = r · (y₀/x₀) · x₁

代入 x₁ · y₁ = k：
x₁ · r · (y₀/x₀) · x₁ = x₀ · y₀

x₁² = x₀² / r

x₁ = x₀ / √r

y₁ = y₀ · √r
```

### 3.3 计算价值对比

**单纯持有的价值（以代币B计价）：**

```
V_hold = x₀ · (r · P₀) + y₀
       = x₀ · r · (y₀/x₀) + y₀
       = r · y₀ + y₀
       = y₀ · (r + 1)
```

**提供流动性的价值：**

```
V_pool = x₁ · (r · P₀) + y₁
       = (x₀/√r) · r · (y₀/x₀) + y₀·√r
       = √r · y₀ + y₀·√r
       = 2·y₀·√r
```

### 3.4 无常损失公式

```
IL = (V_pool - V_hold) / V_hold
   = (2·y₀·√r - y₀·(r+1)) / (y₀·(r+1))
   = (2·√r - r - 1) / (r + 1)
   = 2·√r/(r+1) - 1
```

**最终公式：**

```
IL = 2·√r/(r+1) - 1

其中 r = 新价格/初始价格
```

---

## 4. 不同价格变动的损失

### 4.1 损失表格

| 价格变化 | r值 | 无常损失 |
|---------|-----|---------|
| 不变 | 1.0x | 0% |
| ±25% | 1.25x 或 0.8x | -0.6% |
| ±50% | 1.5x 或 0.67x | -2.0% |
| ±75% | 1.75x 或 0.57x | -3.8% |
| ±100% (2倍) | 2.0x 或 0.5x | -5.7% |
| ±200% (3倍) | 3.0x 或 0.33x | -13.4% |
| ±400% (5倍) | 5.0x 或 0.2x | -25.5% |
| ±900% (10倍) | 10.0x 或 0.1x | -42.0% |

### 4.2 具体实例

#### 实例1：价格翻倍

**初始：**
- 存入 10 ETH ($2000/ETH)
- 存入 20,000 USDC
- 总价值 = $40,000

**ETH涨到$4000（2倍）：**

**如果单纯持有：**
```
10 ETH · $4000 + 20,000 USDC = $60,000
```

**提供流动性：**
```
r = 2
x₁ = 10 / √2 = 7.071 ETH
y₁ = 20,000 · √2 = 28,284 USDC

价值 = 7.071 · $4000 + 28,284 = $56,568
```

**无常损失：**
```
$60,000 - $56,568 = $3,432
损失率 = 3,432 / 60,000 = 5.7%
```

用公式验证：
```
IL = 2·√2/(2+1) - 1 = 2·1.414/3 - 1 = -5.7% ✓
```

#### 实例2：价格5倍

**ETH涨到$10,000（5倍）：**

**单纯持有：**
```
10 ETH · $10,000 + 20,000 = $120,000
```

**提供流动性：**
```
x₁ = 10/√5 = 4.472 ETH
y₁ = 20,000·√5 = 44,721 USDC

价值 = 4.472 · $10,000 + 44,721 = $89,442
```

**无常损失：**
```
$120,000 - $89,442 = $30,558
损失率 = 25.5%
```

**太惨了！ETH涨了5倍，LP却损失了25.5%的收益！**

---

## 5. 手续费vs无常损失

### 5.1 手续费收入

Uniswap V2的LP可以赚取**0.3%的手续费**（每笔交易）。

#### 计算方法

假设每天交易量 = 池子TVL的10%：

```
日交易量 = $100,000 · 10% = $10,000
日手续费 = $10,000 · 0.3% = $30
年手续费 = $30 · 365 = $10,950

如果你的LP占池子1%：
你的年收入 = $10,950 · 1% = $109.5
```

### 5.2 盈亏平衡分析

#### 场景：ETH/USDC池

**假设：**
- 你提供 $10,000 流动性
- 日交易量/TVL = 50%（活跃池子）
- 手续费率 = 0.3%

**手续费收入：**
```
日收入 = $10,000 · 50% · 0.3% = $15
年收入 = $15 · 365 = $5,475
年化收益 = 54.75%
```

**无常损失：**
- 如果ETH价格翻倍，无常损失 = 5.7% = $570
- 需要 $570/$15 = 38 天的手续费才能弥补

**结论：**
- 如果38天内价格回归，你盈利
- 如果价格持续偏离，你可能亏损

---

## 6. 何时值得做LP？

### ✅ 6.1 适合做LP的情况

#### 1. 稳定币池

**例如：USDC/USDT/DAI**
- 价格几乎不变
- 无常损失极小
- 手续费是纯赚

#### 2. 相关资产池

**例如：stETH/ETH, WBTC/renBTC**
- 价格高度相关
- 无常损失小
- 手续费可观

#### 3. 高交易量池

**例如：ETH/USDC on Uniswap**
- 交易量大
- 手续费收入高
- 可能抵消无常损失

#### 4. 长期看好两种资产

如果你同时看好ETH和USDC：
- 无常损失不重要
- 手续费是额外收益

### ❌ 6.2 不适合做LP的情况

#### 1. 高波动性资产对

**例如：SHIB/ETH**
- 山寨币暴涨暴跌
- 无常损失巨大
- 手续费难以弥补

#### 2. 低交易量池

- 手续费收入少
- 无常损失无法弥补
- 流动性可能被困

#### 3. 单边看多某个币

**如果你只看好ETH：**
- 直接持有ETH更好
- 做LP会错过上涨收益

---

## 7. 减少无常损失的方法

### 7.1 选择低波动池

```
稳定币池 > 相关资产池 > 波动资产池

USDC/USDT > stETH/ETH > ETH/SHIB
IL: 0.01%     IL: 1%      IL: 50%+
```

### 7.2 使用V3集中流动性

Uniswap V3允许你选择价格区间：

```
传统LP：在所有价格提供流动性
   价格  流动性
   $0    ███
   $1000 ███
   $2000 ███ ← 你的资金分散
   $3000 ███
   $∞    ███

V3 LP：只在特定区间
   价格  流动性
   $0    
   $1000 
   $1800 ████████ ← 集中在这里
   $2200 ████████
   $3000 
   $∞    
```

**好处：**
- 资金效率提升
- 手续费收入更高
- 但需要主动管理

### 7.3 选择Balancer加权池

80/20池（80% ETH, 20% USDC）：
- 减少卖出ETH的比例
- 降低无常损失
- 但流动性稍差

### 7.4 计算盈亏平衡点

**公式：**

```
需要的手续费收入 = 无常损失

时间 = IL / (日交易量% · 手续费率)
```

**示例：**
```
IL = 5.7% (价格翻倍)
日交易量/TVL = 50%
手续费率 = 0.3%

盈亏平衡时间 = 5.7% / (50% · 0.3%)
             = 5.7% / 0.15%
             = 38 天
```

---

## 🧮 实战计算

### 案例1：ETH暴涨

**你的操作：**
- 存入 10 ETH + 20,000 USDC
- 初始ETH价格 = $2,000
- 池子TVL = $1,000,000
- 你占比 = 4%

**3个月后：**
- ETH涨到 $8,000 (4倍)
- 累计交易量 = $50,000,000
- 你赚取的手续费 = $50M · 0.3% · 4% = $6,000

**计算无常损失：**

```
r = 4
IL = 2·√4/(4+1) - 1
   = 2·2/5 - 1
   = -20%

初始价值 = $40,000
现在如果单纯持有 = 10·$8,000 + $20,000 = $100,000
做LP的价值 = $100,000 · (1-20%) = $80,000
无常损失 = $20,000

但你赚了手续费 = $6,000

净损失 = $20,000 - $6,000 = $14,000
```

**结论：即使赚了$6000手续费，还是亏了$14,000！**

### 案例2：稳定币池

**你的操作：**
- 存入 50,000 USDC + 50,000 USDT
- 价格几乎不变（1.000 ↔ 1.002）

**3个月后：**
- 价格变化 < 0.5%
- 无常损失 ≈ 0.001%
- 手续费收入 = $2,000

**结论：纯赚$2,000！这就是稳定币池受欢迎的原因。**

---

## 📊 无常损失速查表

### 价格变化 vs 损失

```
价格变化    无常损失
1.25x       -0.6%
1.5x        -2.0%
2x          -5.7%    ← 翻倍
3x          -13.4%
4x          -20.0%
5x          -25.5%   ← 5倍
10x         -42.0%   ← 10倍

0.5x        -5.7%    ← 腰斩也一样损失！
0.2x        -25.5%
```

**关键发现：**
- 价格上涨和下跌的损失是**对称的**！
- 腰斩和翻倍的无常损失一样！

---

## 6. 何时值得做LP

### 6.1 决策树

```
你想做LP？
    │
    ├─→ 稳定币池？
    │   └─→ YES ✅ 几乎零风险，手续费纯赚
    │
    ├─→ 高交易量池？
    │   ├─→ YES → 手续费能抵消IL？
    │   │         ├─→ YES ✅ 值得做
    │   │         └─→ NO ❌ 不值得
    │   └─→ NO ❌ 不值得
    │
    └─→ 你看多某个币？
        └─→ YES ❌ 直接持有更好
```

### 6.2 推荐策略

#### 新手策略

```
1. 只做稳定币池（USDC/USDT）
2. 选择大型协议（Uniswap、Curve）
3. 小额开始
4. 观察1-2周
```

#### 进阶策略

```
1. 计算IL vs 手续费
2. 使用V3集中流动性
3. 设置止损位
4. 主动管理位置
```

### 6.3 实际APY计算

**真实收益 = 手续费APY - 无常损失**

```
例如：
手续费APY = 30%
3个月价格翻倍，IL = 5.7%
真实收益 = 30% · 0.25年 - 5.7% = 1.8%

还不如直接持有！
```

---

## 📚 学习资源

### 计算器
- [Impermanent Loss Calculator](https://dailydefi.org/tools/impermanent-loss-calculator/)
- [Uniswap V3 Calculator](https://uniswap.fish/)

### 可视化
- [IL Visualized](https://medium.com/@pintail/uniswap-a-good-deal-for-liquidity-providers-104c0b6816f2)

### 视频
- [Finematics - Impermanent Loss Explained](https://www.youtube.com/watch?v=8XJ1MSTEuU0)

---

## ✅ 学习检查清单

完成本章后，你应该能够：

- [ ] 用自己的话解释什么是无常损失
- [ ] 理解为什么AMM会产生IL
- [ ] 能手算简单的IL（价格翻倍）
- [ ] 知道价格变化和损失的关系
- [ ] 能判断是否值得提供流动性
- [ ] 理解手续费如何抵消IL
- [ ] 知道稳定币池风险最小

---

## 🎯 关键要点

### 记住这3个数字

```
价格翻倍(2x)  → IL = 5.7%
价格5倍(5x)   → IL = 25.5%
价格10倍(10x) → IL = 42.0%
```

### 记住这个原则

```
如果你单边看多某个币 → 直接持有
如果你看好整个赛道 → 可以做LP
如果你要稳定收益 → 做稳定币池
```

---

## 🚀 下一步

恭喜你理解了无常损失！这是区分DeFi新手和老手的分水岭。

继续学习：

1. ✅ **实际案例分析** → 看真实LP的盈亏
2. ✅ **Uniswap V3** → 集中流动性如何改变游戏
3. ✅ **Curve稳定币池** → 为什么IL极低
4. ✅ **LP策略** → 如何最大化收益

---

**记住**：
- ⚠️ **无常损失是LP的最大风险**
- 📊 **价格波动越大，损失越大**
- 💰 **手续费可以抵消损失**
- 🎯 **稳定币池最适合新手**
- 📈 **不要在牛市做波动资产的LP**

现在你已经掌握了DeFi最核心的3个概念！🎉

准备好实战了吗？🚀
