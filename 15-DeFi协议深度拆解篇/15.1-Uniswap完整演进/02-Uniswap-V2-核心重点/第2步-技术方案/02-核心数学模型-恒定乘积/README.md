# Uniswap V2 核心数学模型 - 恒定乘积公式

> 🧮 **深入理解x·y=k的数学原理**
> 
> AMM的核心是数学，理解数学才能理解一切
> 
> ⏱️ 预计学习时间：3-4小时

---

## 📚 目录

1. [恒定乘积公式推导](#1-恒定乘积公式推导)
2. [价格计算机制](#2-价格计算机制)
3. [滑点数学模型](#3-滑点数学模型)
4. [手续费数学处理](#4-手续费数学处理)
5. [流动性数学模型](#5-流动性数学模型)
6. [无常损失数学分析](#6-无常损失数学分析)
7. [TWAP数学原理](#7-twap数学原理)
8. [综合应用案例](#8-综合应用案例)

---

## 1. 恒定乘积公式推导

### 1.1 为什么需要数学模型

**问题背景：**

```
传统交易所：订单簿模式
买单：我要用$2000买1 ETH
卖单：我要卖1 ETH，收$2010

问题：
❌ 需要买卖双方同时在线
❌ 小币种流动性差
❌ 做市商成本高

Uniswap解决方案：
用数学公式替代订单簿
→ 自动做市商 (AMM)
```

### 1.2 设计目标

```
目标1：自动定价
- 不需要人工报价
- 根据储备量自动计算价格

目标2：总是有流动性
- 任何价格都能交易
- 只是滑点不同

目标3：公平透明
- 数学公式公开
- 任何人可验证

目标4：激励兼容
- LP提供流动性有收益
- 套利者帮助平衡价格
```

### 1.3 恒定乘积公式的诞生

**核心思想：**

```
保持一个乘积k恒定：

x · y = k

其中：
- x = 代币0的储备量
- y = 代币1的储备量
- k = 恒定乘积常数

当用户交易时：
- x和y会变化
- 但x·y必须≥k (考虑手续费后)
```

**为什么是乘积，不是和？**

```
方案A：恒定和 (x + y = k)
问题：
- 价格不会变化
- 无法反映供需
- 不适合AMM

方案B：恒定乘积 (x · y = k)
优点：
✅ 价格会随供需变化
✅ 流动性分布合理
✅ 数学性质优美

所以选择恒定乘积！
```

### 1.4 数学推导

**符号定义：**

```
x₀ = 初始代币0储备量
y₀ = 初始代币1储备量
k = x₀ · y₀ = 恒定乘积

Δx = 用户输入的代币0数量
Δy = 用户获得的代币1数量

x₁ = x₀ + Δx = 交易后代币0储备量
y₁ = y₀ - Δy = 交易后代币1储备量
```

**推导过程：**

```
步骤1：恒定乘积约束
x₁ · y₁ = k

步骤2：代入定义
(x₀ + Δx) · (y₀ - Δy) = x₀ · y₀

步骤3：展开
x₀y₀ - x₀Δy + Δx·y₀ - Δx·Δy = x₀y₀

步骤4：消去x₀y₀
-x₀Δy + Δx·y₀ - Δx·Δy = 0

步骤5：移项
Δx·y₀ - Δx·Δy = x₀Δy

步骤6：提取Δx
Δx(y₀ - Δy) = x₀Δy

步骤7：解出Δy
Δy = (Δx · y₀) / (x₀ + Δx)
```

**最终公式：**

```
⭐ 核心公式：

Δy = (Δx · y₀) / (x₀ + Δx)

含义：
- 输入Δx数量的代币0
- 可以获得Δy数量的代币1
- y₀和x₀是池子当前储备量
```

### 1.5 几何意义

**双曲线：**

```
x · y = k 是一条双曲线

可视化：

  y |
    |     ·
    |    ·
    |   ·
    |  ·        ← 曲线：x·y=k
    | ·
    |·___________________
    0                   x

特点：
1. 永远不会触及坐标轴
   → 永远有流动性

2. 离轴越远，曲线越平
   → 大池子滑点小

3. 对称性
   → x和y可互换
```

**交易的几何含义：**

```
交易前：点A(x₀, y₀)在曲线上
交易后：点B(x₁, y₁)在曲线上

       y
       |
    y₀ •A
       |  \
       |   \
    y₁ |    •B
       |
       |___________x
          x₀  x₁

从A移动到B
- x增加：Δx = x₁ - x₀
- y减少：Δy = y₀ - y₁
- 仍在曲线上：x₁·y₁ = k
```

---

## 2. 价格计算机制

### 2.1 边际价格

**定义：**

```
边际价格 = 当前瞬时价格

P = dy/dx = -y/x

推导：
对 x·y = k 求微分
x·dy + y·dx = 0
dy/dx = -y/x

含义：
价格 = 代币1储备 / 代币0储备
```

**例子：**

```
池子状态：
x = 10,000 ETH
y = 20,000,000 USDC

边际价格：
P = y/x = 20,000,000 / 10,000 = 2000 USDC/ETH

含义：
当前ETH价格是$2000
```

### 2.2 平均价格

**定义：**

```
平均价格 = 实际交易价格

P_avg = Δy / Δx

与边际价格不同！
因为大额交易会移动价格
```

**例子：**

```
买入100 ETH：

边际价格：$2000
实际平均价格：$2050
差异：价格影响$50

为什么？
因为随着购买，ETH变少，价格上涨
```

### 2.3 价格影响

**定义：**

```
价格影响 = 交易对价格的影响

ΔP/P = Δx/x

推导：
初始价格：P₀ = y₀/x₀
最终价格：P₁ = y₁/x₁ = y₁/(x₀+Δx)

价格变化：
ΔP = P₁ - P₀

比例：
ΔP/P₀ ≈ Δx/x₀ (对于小Δx)
```

**例子：**

```
池子：10,000 ETH

买入100 ETH：
价格影响 = 100/10,000 = 1%
价格从$2000涨到$2020

买入1000 ETH：
价格影响 = 1000/10,000 = 10%
价格从$2000涨到约$2200

影响与交易量成正比！
```

### 2.4 价格发现机制

**套利平衡：**

```
如果Uniswap价格 ≠ 市场价格
→ 套利者出现
→ 买低卖高
→ 价格回归平衡

例子：
市场价：$2000
Uniswap：$1980 (便宜)

套利者：
1. 在Uniswap买ETH ($1980)
2. 在CEX卖ETH ($2000)
3. 赚$20/ETH

效果：
Uniswap价格↑ → 接近$2000

这就是价格发现机制！
```

---

## 3. 滑点数学模型

### 3.1 滑点定义

```
滑点 = 期望价格 vs 实际价格的差异

Slippage = (P_actual - P_expected) / P_expected

原因：
随着交易，储备量变化
→ 价格随之变化
→ 产生滑点
```

### 3.2 滑点公式推导

**从x·y=k推导：**

```
已知：
Δy = (Δx · y₀) / (x₀ + Δx)

实际平均价格：
P_actual = Δy / Δx = y₀ / (x₀ + Δx)

期望价格（边际价格）：
P_expected = y₀ / x₀

滑点：
s = (P_expected - P_actual) / P_expected
  = [(y₀/x₀) - (y₀/(x₀+Δx))] / (y₀/x₀)
  = [y₀(x₀+Δx) - y₀x₀] / [y₀(x₀+Δx)] × (x₀/y₀)
  = [y₀Δx] / [y₀(x₀+Δx)] × (x₀/y₀)
  = Δx / (x₀ + Δx)
```

**⭐ 滑点公式：**

```
s = Δx / (x₀ + Δx)

或者：
s = Δx/x₀ / (1 + Δx/x₀)

简化（当Δx << x₀时）：
s ≈ Δx / x₀
```

### 3.3 滑点计算示例

**例子1：小额交易**

```
池子：x₀ = 10,000 ETH
交易：Δx = 10 ETH (0.1%)

滑点：
s = 10 / (10,000 + 10)
  = 10 / 10,010
  = 0.0999%
  ≈ 0.1%

结论：
交易量占比0.1%
滑点约0.1%
```

**例子2：中等交易**

```
池子：x₀ = 10,000 ETH
交易：Δx = 100 ETH (1%)

滑点：
s = 100 / (10,000 + 100)
  = 100 / 10,100
  = 0.99%
  ≈ 1%

结论：
交易量占比1%
滑点约1%
```

**例子3：大额交易**

```
池子：x₀ = 10,000 ETH
交易：Δx = 1,000 ETH (10%)

滑点：
s = 1,000 / (10,000 + 1,000)
  = 1,000 / 11,000
  = 9.09%

结论：
交易量占比10%
滑点9.09%
明显的非线性！
```

### 3.4 滑点优化策略

**策略1：分批交易**

```
大额交易分多笔：

一次性买1000 ETH：
滑点 = 9.09%

分10次，每次100 ETH：
每次滑点 ≈ 1%
但要考虑：
- 价格恢复
- 套利者
- Gas费

实际滑点 < 9.09%
```

**策略2：多池路由**

```
如果有多个池子：
- Pool A: ETH/USDC
- Pool B: ETH/DAI  
- Pool C: USDC/DAI

可以优化路径降低滑点
→ 这是聚合器的价值
```

**策略3：等待流动性增加**

```
如果不急：
等待更多LP
→ 池子变大
→ 滑点降低
```

---

## 4. 手续费数学处理

### 4.1 手续费机制

**V2手续费：**

```
交易手续费：0.3%

分配：
- 100%给LP (默认)
- 或 83.3%给LP + 16.7%给协议 (可选)

实现方式：
不是直接收取
而是改变k值
```

### 4.2 包含手续费的公式

**修正的恒定乘积：**

```
无手续费：
x₁ · y₁ = x₀ · y₀

有手续费（0.3%）：
(x₀ + 0.997Δx) · (y₀ - Δy) = x₀ · y₀

解释：
用户输入Δx
但只有99.7%进入流动性
0.3%被收取作为手续费
```

**推导输出量公式：**

```
(x₀ + 0.997Δx) · (y₀ - Δy) = x₀ · y₀

展开：
x₀y₀ - x₀Δy + 0.997Δx·y₀ - 0.997Δx·Δy = x₀y₀

化简：
-x₀Δy + 0.997Δx·y₀ - 0.997Δx·Δy = 0

忽略二阶小量Δx·Δy：
-x₀Δy + 0.997Δx·y₀ = 0

解出Δy：
Δy = (0.997Δx · y₀) / x₀

更精确（不忽略）：
Δy = (0.997Δx · y₀) / (x₀ + 0.997Δx)
```

**⭐ 含手续费公式：**

```
Δy = (997Δx · y₀) / (1000x₀ + 997Δx)

Solidity实现中乘1000避免小数
```

### 4.3 手续费对k的影响

**k值增长：**

```
初始：k₀ = x₀ · y₀

交易后（用户输入Δx，获得Δy）：
x₁ = x₀ + Δx
y₁ = y₀ - Δy

新k值：
k₁ = x₁ · y₁
   = (x₀ + Δx) · (y₀ - Δy)

因为收取了0.3%手续费：
k₁ > k₀

增长量：
Δk = k₁ - k₀
```

**LP收益来源：**

```
LP收益 = k值增长

例子：
初始：k₀ = 1000万
交易后：k₁ = 1003万
增长：3万 (0.3%手续费导致)

这3万的增长由所有LP共享！
```

### 4.4 有效价格

**考虑手续费后的实际价格：**

```
无手续费价格：
P₀ = y₀ / x₀

用户实际支付（含0.3%手续费）：
P_effective = Δy / Δx
            = [997Δx·y₀ / (1000x₀+997Δx)] / Δx
            = 997y₀ / (1000x₀ + 997Δx)

手续费影响：
对小额交易：≈ 0.3%
对大额交易：0.3% + 滑点
```

---

## 5. 流动性数学模型

### 5.1 LP代币发行

**初始流动性：**

```
第一个LP添加流动性：
x₀ = 初始代币0数量
y₀ = 初始代币1数量

铸造LP代币：
L₀ = √(x₀ · y₀)

为什么用几何平均数？
- 不依赖价格
- 对称性
- 数学性质好
```

**后续流动性：**

```
已有流动性：
L_total = 当前总LP代币
x_reserve = 代币0储备
y_reserve = 代币1储备

新LP添加：
Δx = 添加的代币0
Δy = 添加的代币1

铸造LP代币：
ΔL = L_total · min(Δx/x_reserve, Δy/y_reserve)

为什么用min？
保证不改变池子价格
```

### 5.2 添加流动性公式推导

**符号定义：**

```
添加前：
- x₀ = 代币0储备
- y₀ = 代币1储备  
- L₀ = 总LP代币
- P₀ = y₀/x₀ = 价格

添加：
- Δx = 添加代币0
- Δy = 添加代币1
- ΔL = 获得LP代币

添加后：
- x₁ = x₀ + Δx
- y₁ = y₀ + Δy
- L₁ = L₀ + ΔL
```

**推导：**

```
要求：
价格不变 → y₁/x₁ = y₀/x₀

即：
(y₀+Δy)/(x₀+Δx) = y₀/x₀

比例相同：
Δy/y₀ = Δx/x₀

LP代币比例：
ΔL/L₀ = Δx/x₀ = Δy/y₀

解出：
ΔL = L₀ · (Δx/x₀)
或
ΔL = L₀ · (Δy/y₀)
```

**⭐ 流动性公式：**

```
ΔL = L₀ · min(Δx/x₀, Δy/y₀)

Solidity实现：
liquidity = Math.min(
    amount0 * totalSupply / reserve0,
    amount1 * totalSupply / reserve1
);
```

### 5.3 移除流动性

**公式：**

```
LP想移除流动性：
燃烧ΔL个LP代币

获得：
Δx = x_reserve · (ΔL / L_total)
Δy = y_reserve · (ΔL / L_total)

比例返还！
```

**例子：**

```
池子状态：
- x_reserve = 10,000 ETH
- y_reserve = 20,000,000 USDC
- L_total = 200,000 LP代币

LP持有：10,000 LP代币 (5%)

移除所有流动性：
Δx = 10,000 × (10,000/200,000) = 500 ETH
Δy = 20,000,000 × (10,000/200,000) = 1,000,000 USDC

获得5%的储备量
```

---

## 6. 无常损失数学分析

### 6.1 无常损失定义

```
无常损失 = LP vs HODL的收益差

如果只是持有代币（HODL）：
持有收益 = 价格变化

如果提供流动性（LP）：
LP收益 = 价格变化 + 手续费 - 无常损失

无常损失 = 价格变化导致的隐性损失
```

### 6.2 无常损失公式推导

**场景设定：**

```
初始：
- x₀个token0
- y₀个token1  
- P₀ = y₀/x₀ = 初始价格

价格变为P₁：
- P₁ = αP₀ (α为价格倍数)

情况1：HODL
价值 = x₀·P₁ + y₀

情况2：LP (假设无手续费)
因为k=xy恒定且套利后价格=P₁
可求出新的x₁, y₁
价值 = x₁·P₁ + y₁
```

**数学推导：**

```
k = x₀·y₀ = x₁·y₁ (恒定)

套利后价格为P₁：
P₁ = y₁/x₁

从两个等式：
y₁ = P₁·x₁
x₁·y₁ = x₀·y₀

解出：
x₁·P₁·x₁ = x₀·y₀
x₁² = x₀·y₀/P₁
x₁ = √(x₀·y₀/P₁)

y₁ = √(x₀·y₀·P₁)

LP价值：
V_LP = x₁·P₁ + y₁
     = P₁·√(x₀·y₀/P₁) + √(x₀·y₀·P₁)
     = √(x₀·y₀·P₁) + √(x₀·y₀·P₁)
     = 2√(x₀·y₀·P₁)

HODL价值（初始50/50分配）：
V_HODL = x₀·P₁ + y₀
       = x₀·P₁ + P₀·x₀
       = x₀(P₁ + P₀)

因为y₀ = P₀·x₀
```

**简化（设P₁ = α·P₀）：**

```
V_LP = 2√(x₀·y₀·α·P₀)
     = 2√(x₀·P₀·x₀·α·P₀)
     = 2x₀·P₀√α

V_HODL = x₀·P₁ + y₀
       = x₀·α·P₀ + x₀·P₀
       = x₀·P₀(α + 1)

无常损失：
IL = (V_HODL - V_LP) / V_HODL
   = [x₀·P₀(α+1) - 2x₀·P₀√α] / [x₀·P₀(α+1)]
   = [(α+1) - 2√α] / (α+1)
```

**⭐ 无常损失公式：**

```
IL(α) = [2√α / (α+1)] - 1

或者：
IL(α) = [(√α - 1)² / (α + 1)]

其中 α = P₁/P₀ = 价格变化倍数
```

### 6.3 无常损失计算表

```
价格变化    α值    无常损失
────────────────────────────
+25%      1.25    -0.6%
+50%      1.50    -2.0%
+75%      1.75    -3.8%
+100%     2.00    -5.7%
+200%     3.00    -13.4%
+400%     5.00    -25.5%

-25%      0.75    -0.6%
-50%      0.50    -5.7%
-75%      0.25    -20.0%

观察：
1. 对称性：涨跌同样损失
2. 非线性：价格变化越大，损失越大
3. 50%变化 → 5.7%损失
4. 2倍变化 → 5.7%损失
5. 5倍变化 → 25.5%损失
```

### 6.4 无常损失可视化

```
IL vs 价格变化：

IL%  |
  0% |     ·
     |    / \
 -5% |   /   \
     |  /     \
-10% | /       \
     |/_________\______ α
      0.5  1  2   5

特点：
1. α=1时IL=0（价格不变）
2. 对称曲线
3. 价格变化越大，IL越大
4. 永远是负的（损失）
```

### 6.5 实际案例

**案例1：ETH价格翻倍**

```
初始：
- 添加10 ETH + 20,000 USDC
- ETH价格 = $2000
- 总价值 = $40,000

ETH涨到$4000（2倍）：

HODL策略：
- 10 ETH × $4000 = $40,000
- 20,000 USDC = $20,000
- 总价值 = $60,000

LP策略（无手续费）：
- 套利后：7.07 ETH + 28,284 USDC
- 价值 = 7.07×$4000 + $28,284 = $56,568
- 无常损失 = $60,000 - $56,568 = $3,432 (5.7%)

但LP还有手续费收入！
假设收了$5,000手续费
实际 = $56,568 + $5,000 = $61,568
比HODL还多$1,568

所以：手续费可以弥补无常损失
```

---

## 7. TWAP数学原理

### 7.1 TWAP定义

```
TWAP = Time-Weighted Average Price
     = 时间加权平均价格

不是简单平均
而是考虑每个价格持续的时间
```

### 7.2 累积价格机制

**Uniswap V2实现：**

```
不存储所有历史价格
而是存储累积价格：

price_cumulative = Σ(price_i × time_i)

每次交易更新：
price_cumulative += current_price × time_elapsed
```

**数学推导：**

```
在时间段[t₀, t₁]内：

TWAP = ∫[t₀,t₁] price(t) dt / (t₁ - t₀)

离散化：
TWAP = Σ(price_i × Δt_i) / Σ(Δt_i)

Uniswap存储：
price_cumulative(t) = Σ[0,t] price(τ) dτ

计算区间[t₀, t₁]的TWAP：
TWAP = [price_cumulative(t₁) - price_cumulative(t₀)] / (t₁ - t₀)
```

### 7.3 TWAP计算示例

**场景：**

```
时刻t₀: price = $2000, cumulative = 1,000,000
时刻t₁: price = $2100, cumulative = 1,050,000
时间差: t₁ - t₀ = 1小时 = 3600秒

1小时TWAP：
TWAP = (1,050,000 - 1,000,000) / 3600
     = 50,000 / 3600
     = $13.89/秒

wait不对！
这是错误示例，实际需要考虑编码

正确的：
price累积值是编码后的
需要用UQ112.112解码
```

**正确示例：**

```
假设累积价格已正确编码

时刻t₀:
- reserve0 = 10,000 ETH
- reserve1 = 20,000,000 USDC
- price = 2000
- price_cumulative₀ = X

等待1小时...

时刻t₁:
- reserve0 = 10,100 ETH (有交易)
- reserve1 = 19,801,980 USDC
- price ≈ 1960
- price_cumulative₁ = Y

1小时TWAP：
TWAP = (Y - X) / 3600

这个TWAP反映了1小时的平均价格
不容易被单笔大额交易操纵
```

### 7.4 TWAP防操纵原理

**为什么安全？**

```
攻击即时价格：
1. 用闪电贷买入大量ETH
2. 价格暴涨到$3000
3. 其他协议读取$3000
4. 攻击者套利
5. 还闪电贷
成本：~$1000
时间：1个交易
可行！✅

攻击1小时TWAP：
1. 买入大量ETH，推高到$3000
2. 保持1小时（不能卖！）
3. 其他协议读取TWAP
4. 1小时后卖出

成本：
- 资金成本：锁定1小时，数百万美元
- 滑点成本：买入+卖出，20-40%
- 总成本：可能数十万到百万美元
可行性：×

攻击成本提升100-1000倍！
```

---

## 8. 综合应用案例

### 8.1 实际swap计算

**场景：**

```
池子状态：
- ETH储备：10,000 ETH
- USDC储备：20,000,000 USDC
- 当前价格：$2000/ETH
- 总LP代币：200,000

用户：用100 ETH买USDC
```

**计算过程：**

```
步骤1：计算输出（含0.3%手续费）
Δx = 100 ETH
x₀ = 10,000 ETH
y₀ = 20,000,000 USDC

Δy = (997 × 100 × 20,000,000) / (1000 × 10,000 + 997 × 100)
   = 1,994,000,000 / 1,099,700
   = 1,813,471 USDC

步骤2：计算实际价格
平均价格 = 1,813,471 / 100 = $18,134.71/ETH

步骤3：计算滑点
边际价格 = $20,000,000 / 10,000 = $2000
滑点 = (2000 - 18134.71/100) / 2000
     = (2000 - 1813.47) / 2000
     = 9.33%

步骤4：更新储备
新ETH储备 = 10,000 + 100 = 10,100
新USDC储备 = 20,000,000 - 1,813,471 = 18,186,529

验证k：
旧k = 10,000 × 20,000,000 = 200,000,000,000
新k = 10,100 × 18,186,529 = 183,684,143,900
(考虑手续费，新k会略大于旧k)

实际新k应该：
= (10,000 + 0.997×100) × (20,000,000 - 1,813,471)
= 10,099.7 × 18,186,529
≈ 200,600,000,000

k增加了！手续费导致的。
```

### 8.2 流动性计算

**添加流动性：**

```
池子状态：
- ETH：10,000
- USDC：20,000,000
- LP代币：200,000
- 价格：$2000

用户添加：
- 50 ETH
- 100,000 USDC

计算LP代币：
ratio1 = 50 / 10,000 = 0.5%
ratio2 = 100,000 / 20,000,000 = 0.5%

ΔL = 200,000 × 0.5% = 1,000 LP代币

新状态：
- ETH：10,050
- USDC：20,100,000
- LP代币：201,000
```

**移除流动性：**

```
LP燃烧1,000 LP代币

获得：
ETH = 10,050 × (1,000/201,000) = 50 ETH
USDC = 20,100,000 × (1,000/201,000) = 100,000 USDC

比例返还！
```

---

## ✅ 学习检查清单

### Level 1：基础公式
- [ ] 能写出x·y=k公式
- [ ] 理解k的几何意义
- [ ] 能计算简单的swap
- [ ] 知道价格=y/x
- [ ] 理解滑点的概念

### Level 2：公式推导
- [ ] 能推导Δy公式
- [ ] 能推导滑点公式
- [ ] 理解手续费如何影响k
- [ ] 能计算LP代币数量
- [ ] 理解无常损失公式

### Level 3：综合应用
- [ ] 能独立计算复杂场景
- [ ] 能优化滑点
- [ ] 理解TWAP原理
- [ ] 能分析无常损失
- [ ] 能设计数学模型

---

## 💡 练习题

### 练习1：基础计算
```
池子：1000 ETH, 2,000,000 USDC
用户：用10 ETH买USDC
问：获得多少USDC？（忽略手续费）
```

### 练习2：滑点计算
```
同上池子，计算：
1. 边际价格
2. 实际平均价格
3. 滑点百分比
```

### 练习3：手续费影响
```
同上，考虑0.3%手续费
重新计算获得的USDC
```

### 练习4：无常损失
```
初始：10 ETH + 20,000 USDC ($2000/ETH)
ETH涨到$3000
计算：
1. HODL价值
2. LP价值（无手续费）
3. 无常损失百分比
```

**答案在最后！**

---

## 🎓 总结

恒定乘积公式x·y=k是Uniswap的数学基础：

```
✅ 简单优雅
✅ 数学性质好
✅ 永远有流动性
✅ 价格随供需变化
✅ 激励兼容

这个公式改变了DeFi！
```

**下一步** → [03-架构设计-三合约模式](../03-架构设计-三合约模式/README.md)

在那里你将学习如何将数学模型实现为智能合约架构！

---

## 📝 练习题答案

**练习1答案：**
```
Δy = Δx × y / (x + Δx)
   = 10 × 2,000,000 / (1000 + 10)
   = 20,000,000 / 1010
   = 19,801.98 USDC
```

**练习2答案：**
```
1. 边际价格 = 2,000,000/1000 = $2000
2. 平均价格 = 19,801.98/10 = $1980.20
3. 滑点 = (2000-1980.20)/2000 = 0.99%
```

**练习3答案：**
```
Δy = 997×10×2,000,000 / (1000×1000 + 997×10)
   = 19,940,000 / 1,009,970
   = 19,742.57 USDC
```

**练习4答案：**
```
1. HODL = 10×$3000 + $20,000 = $50,000
2. LP值（套利后7.45 ETH + 22,361 USDC）
   = 7.45×$3000 + $22,361 = $44,711
3. IL = ($50,000-$44,711)/$50,000 = 10.6%
```

恭喜完成数学模型学习！💪