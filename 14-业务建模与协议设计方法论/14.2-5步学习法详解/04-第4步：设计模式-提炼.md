# 第4步：设计模式 - 提炼可复用知识

> 💡 **理解PATTERN：从具体到抽象**
> 
> 提炼设计模式，建立可复用的知识体系

---

## 核心问题

在第4步，你需要回答：

```
1. 有哪些业务模式？
   → 可复用的商业逻辑？

2. 有哪些技术模式？
   → 可复用的代码结构？

3. 有哪些安全模式？
   → 可复用的安全实践？

4. 如何应用这些模式？
   → 在其他项目中如何使用？
```

---

## 三类设计模式

### 1. 业务模式

```
从Uniswap V2提炼的业务模式：

模式1：双边市场
- LP提供供给
- Trader创造需求
- 手续费连接双方

可应用：
✅ 任何双边市场
✅ 借贷协议（存款人+借款人）
✅ NFT市场（卖家+买家）

模式2：无需许可
- 任何人可创建Pair
- 任何人可提供流动性
- 任何人可交易

可应用：
✅ 去中心化应用的核心
✅ 降低准入门槛
✅ 扩大用户基础

模式3：数学定价
- 用公式替代人工
- x·y=k自动做市
- 完全透明

可应用：
✅ AMM算法
✅ 利率模型（Compound）
✅ 合成资产定价（Synthetix）
```

### 2. 技术模式

```
从Uniswap V2提炼的技术模式：

模式1：分层架构
- Core层：不可变，安全
- Periphery层：可升级，灵活

可应用：
✅ 任何需要平衡安全和灵活的系统
✅ Aave、Compound都采用类似架构

模式2：工厂模式
- Factory统一创建
- create2确定性部署
- 全局注册表

可应用：
✅ 需要创建多个相似合约的场景
✅ NFT工厂、代币工厂

模式3：门面模式
- Router简化接口
- 封装复杂逻辑
- 提供便利函数

可应用：
✅ 任何需要用户友好接口的协议
✅ 聚合器、SDK

模式4：Library模式
- 纯函数工具
- 代码复用
- 节省部署成本

可应用：
✅ 数学计算库
✅ 地址计算库
✅ 安全检查库
```

### 3. 安全模式

```
从Uniswap V2提炼的安全模式：

模式1：检查-生效-交互（CEI）
- 先检查条件
- 再改变状态
- 最后外部调用

可应用：
✅ 所有智能合约的基本原则
✅ 防止重入攻击

模式2：乐观执行
- 先转账
- 后验证
- 失败回滚

可应用：
✅ Flash Loan
✅ 闪电兑换
✅ 原子操作

模式3：不变式验证
- 定义系统不变式（x·y≥k）
- 每次操作后验证
- 保证系统安全

可应用：
✅ 任何有数学约束的系统
✅ 借贷协议的抵押率
✅ 稳定币的锚定价格

模式4：多重保护
- 时间检查（deadline）
- 数量检查（slippage）
- 逻辑检查（k值）

可应用：
✅ 用户资金安全的关键
✅ 多层防御思想
```

---

## 模式应用案例

### 案例：设计一个借贷协议

```
应用Uniswap V2的模式：

业务模式：
✅ 双边市场（存款人+借款人）
✅ 无需许可（任何人可参与）
✅ 数学定价（利率模型）

技术模式：
✅ 分层架构（Core存款+Periphery前端）
✅ 工厂模式（创建不同的市场）
✅ 门面模式（简化用户接口）

安全模式：
✅ CEI模式（先更新状态再转账）
✅ 不变式验证（抵押率>安全线）
✅ 多重保护（价格检查+健康因子+清算阈值）

这些模式都是从Uniswap学到的！
```

---

## 模式提炼输出

### 产出物清单

```
□ 业务模式库
  - 描述
  - 适用场景
  - 代码模板

□ 技术模式库
  - 实现方式
  - 优缺点
  - 应用案例

□ 安全模式库
  - 安全威胁
  - 防护机制
  - 检查清单
```

---

## ✅ 检查清单

- [ ] 提炼至少3个业务模式
- [ ] 提炼至少5个技术模式
- [ ] 提炼至少5个安全模式
- [ ] 每个模式都有应用案例
- [ ] 能在新项目中应用这些模式

---

**完成后** → [第5步：独立实战](./05-第5步：独立实战-创造.md) ← 开始创造！
