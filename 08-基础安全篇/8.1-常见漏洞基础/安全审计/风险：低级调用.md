# é£é™©ï¼šä½çº§è°ƒç”¨

### 1. ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼šé«˜çº§è°ƒç”¨ vs. ä½çº§è°ƒç”¨



åœ¨æ™ºèƒ½åˆçº¦ä¸­ï¼Œä¸å¦ä¸€ä¸ªåˆçº¦äº¤äº’ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

- **é«˜çº§è°ƒç”¨ (High-Level Calls)**ï¼š
  **é«˜çº§è°ƒç”¨ï¼ˆHigh-Level Callsï¼‰** ï¼š
  - è¿™æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨ã€æœ€æ¨èçš„æ–¹å¼ã€‚
  - è¯­æ³•ï¼š`OtherContract(contractAddress).someFunction(arg1, arg2);`
  - **å…³é”®ç‰¹æ€§**ï¼šè¿™ç§è°ƒç”¨æ–¹å¼æ˜¯â€œå…¨è‡ªåŠ¨â€å’Œâ€œå®‰å…¨çš„â€ã€‚å¦‚æœ `someFunction` æ‰§è¡Œå¤±è´¥å¹¶ `revert`ï¼Œè¿™ä¸ª `revert` ä¼šè‡ªåŠ¨**ä¼ æ’­ (propagate)** å›æ¥ï¼Œå¯¼è‡´ä½ å½“å‰å‡½æ•°çš„æ‰§è¡Œä¹Ÿç«‹å³å¤±è´¥å¹¶å›æ»šã€‚ä½ ä¸éœ€è¦æ‰‹åŠ¨æ£€æŸ¥ä»»ä½•ä¸œè¥¿ã€‚
- **ä½çº§è°ƒç”¨ (Low-Level Calls)**ï¼š
  **ä½çº§è°ƒç”¨ï¼ˆLow-Level Callsï¼‰** ï¼š
  - è¿™äº›æ˜¯æ›´åº•å±‚çš„ã€æ›´æ¥è¿‘ EVM æ“ä½œç çš„å‡½æ•°ï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ›´å¤§çš„é£é™©ã€‚
  - ä¸»è¦åŒ…æ‹¬ï¼š**`.call()`**, **`.delegatecall()`**, **`.staticcall()`**, ä»¥åŠç°åœ¨**ä¸æ¨èä½¿ç”¨**çš„ **`.send()`** å’Œ **`.transfer()`**ã€‚
  - **å…³é”®ç‰¹æ€§**ï¼šè¿™æ˜¯æ¼æ´çš„æ ¸å¿ƒã€‚å½“ä¸€ä¸ªä½çº§è°ƒç”¨æ‰§è¡Œå¤±è´¥æ—¶ï¼Œå®ƒ**ä¸ä¼šè‡ªåŠ¨ `revert`**ï¼ç›¸åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ `success` æ¥å‘Šè¯‰ä½ è°ƒç”¨æ˜¯å¦æˆåŠŸï¼ˆé€šå¸¸ `success` ä¼šæ˜¯ `false`ï¼‰ã€‚

**æ ¸å¿ƒçŸ›ç›¾**ï¼šé«˜çº§è°ƒç”¨å¤±è´¥æ—¶ä¼šâ€œå¤§å£°å–Šå«â€ï¼ˆrevertï¼‰ï¼Œè€Œä½çº§è°ƒç”¨å¤±è´¥æ—¶åªä¼šâ€œå°å£°å˜€å’•â€ï¼ˆè¿”å› a `false`ï¼‰ã€‚å¦‚æœä½ ä¸å»ä¸»åŠ¨â€œå¬â€è¿™ä¸ªç»“æœï¼Œä½ çš„åˆçº¦å°±ä¼šä»¥ä¸ºä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚

------



### 2. æœªæ£€æŸ¥çš„ä½çº§è°ƒç”¨ï¼šæ¼æ´çš„æ ¹æº



â€œæœªæ£€æŸ¥çš„ä½çº§è°ƒç”¨â€æ¼æ´ï¼Œå°±æ˜¯æŒ‡å¼€å‘è€…ä½¿ç”¨äº† `.call()`, `.send()` ç­‰ä½çº§å‡½æ•°ï¼Œä½†**æ²¡æœ‰æ£€æŸ¥å®ƒä»¬è¿”å›çš„ `success` å¸ƒå°”å€¼**ã€‚

åˆçº¦ä¼šå¤©çœŸåœ°è®¤ä¸ºå¤–éƒ¨è°ƒç”¨å·²ç»æˆåŠŸï¼Œå¹¶ç»§ç»­æ‰§è¡Œåç»­çš„é€»è¾‘ï¼ˆä¾‹å¦‚æ›´æ–°çŠ¶æ€å˜é‡ï¼‰ï¼Œä½†è¿™ä¸é“¾ä¸Šçš„å®é™…æƒ…å†µå®Œå…¨ä¸ç¬¦ï¼Œå¯¼è‡´åˆçº¦çŠ¶æ€å‡ºç°ä¸¥é‡çš„ä¸ä¸€è‡´ã€‚



### 3. ä½çº§è°ƒç”¨å‡½æ•°è¯¦è§£ä¸é£é™©



- **`address.call(bytes memory data)` -> `(bool success, bytes memory data)`**
  - **åŠŸèƒ½**ï¼šæœ€é€šç”¨ã€æœ€å¼ºå¤§çš„ä½çº§è°ƒç”¨ã€‚å¯ä»¥ç”¨æ¥å‘é€ ETHï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ç›®æ ‡åˆçº¦çš„ä»»æ„å‡½æ•°ã€‚
  - **é£é™©**ï¼šå¦‚æœä½ ä¸æ£€æŸ¥è¿”å›çš„ `success`ï¼Œå½“è°ƒç”¨å¤±è´¥æ—¶ï¼Œä½ çš„åˆçº¦ä¼šæ¯«ä¸çŸ¥æƒ…åœ°ç»§ç»­æ‰§è¡Œã€‚è¿™æ˜¯æœ€å¸¸è§çš„æ¼æ´æ¥æºã€‚
- **`address.send(uint256 amount)` -> `(bool success)` (ä¸æ¨èä½¿ç”¨)**
  - **åŠŸèƒ½**ï¼šä¸€ä¸ªä¸“é—¨ç”¨æ¥å‘é€ ETH çš„å‡½æ•°ã€‚
  - **é£é™©**ï¼š
    1. **åŒæ ·éœ€è¦æ£€æŸ¥è¿”å›å€¼**ã€‚`someAddress.send(1 ether);` è¿™æ ·å†™æ˜¯**æå…¶å±é™©çš„**ã€‚
    2. **å›ºå®š Gas æ´¥è´´**ï¼š`send` åªæä¾› 2300 Gas ç”¨äºæ‰§è¡Œã€‚å¦‚æœæ¥æ”¶æ–¹æ˜¯ä¸€ä¸ªåˆçº¦ï¼Œå¹¶ä¸”å…¶ `receive()` æˆ– `fallback()` å‡½æ•°çš„é€»è¾‘ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼ˆä¾‹å¦‚ï¼Œå†™å…¥ä¸€ä¸ªå­˜å‚¨å˜é‡ï¼‰ï¼ŒGas å°±ä¼šä¸å¤Ÿç”¨ï¼Œå¯¼è‡´ `send` å¤±è´¥ã€‚è¿™ä¼šä½¿ä½ çš„åˆçº¦æ— æ³•ä¸æŸäº›åˆçº¦äº¤äº’ã€‚
- **`address.transfer(uint256 amount)` (ä¸æ¨èä½¿ç”¨)**
  - **åŠŸèƒ½**ï¼šä¹Ÿæ˜¯ä¸“é—¨ç”¨æ¥å‘é€ ETH çš„ã€‚
  - **ä¸ `send` çš„åŒºåˆ«**ï¼š`.transfer()` åœ¨å¤±è´¥æ—¶ä¼šè‡ªåŠ¨ `revert`ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œå®ƒæ¯” `send` å®‰å…¨ã€‚
  - **é£é™©**ï¼šå®ƒå’Œ `send` ä¸€æ ·ï¼Œä¹Ÿåªæœ‰ 2300 Gas çš„æ´¥è´´ï¼ŒåŒæ ·å­˜åœ¨ä¸å¤æ‚åˆçº¦äº¤äº’å¤±è´¥çš„é—®é¢˜ã€‚éšç€æœªæ¥ Gas æˆæœ¬çš„å˜åŒ–ï¼Œä¾èµ–å›ºå®š Gas çš„å‡½æ•°éƒ½æ˜¯è„†å¼±çš„ã€‚

**ç°ä»£æœ€ä½³å®è·µ**ï¼šå½“éœ€è¦å‘é€ ETH æ—¶ï¼Œ**åº”è¯¥ä½¿ç”¨ `.call()`**ã€‚ `(bool success, ) = payable(recipientAddress).call{value: amount}("");` `require(success, "Failed to send Ether");` è¿™ç§æ–¹å¼ä¼šè½¬å‘æ‰€æœ‰å¯ç”¨çš„ Gasï¼Œæ›´åŠ å¥å£®å’Œé¢å‘æœªæ¥ã€‚

------

### 4. æ”»å‡»åœºæ™¯å®ä¾‹

å‡è®¾æœ‰ä¸€ä¸ªå¤šæ–¹å‚ä¸çš„ä¼—ç­¹åˆçº¦ï¼Œé¡¹ç›®å¤±è´¥åï¼Œç”¨æˆ·å¯ä»¥å–å›è‡ªå·±çš„æŠ•èµ„ã€‚

**æœ‰æ¼æ´çš„ä»£ç  ğŸ‘**

```
contract UnsafeCrowdfund {
    mapping(address => uint256) public contributions;

    // ... å…¶ä»–å‡½æ•° ...

    function refund() public {
        uint256 amount = contributions[msg.sender];
        require(amount > 0, "No contribution to refund.");

        // **æ¼æ´ç‚¹**ï¼šä½¿ç”¨äº† .send() ä½†æ²¡æœ‰æ£€æŸ¥å…¶è¿”å›å€¼
        payable(msg.sender).send(amount);

        // æ— è®º send æ˜¯å¦æˆåŠŸï¼Œä»£ç éƒ½ä¼šç»§ç»­æ‰§è¡Œåˆ°è¿™é‡Œ
        contributions[msg.sender] = 0;
    }
}
```

**æ”»å‡»/åˆ©ç”¨æ–¹å¼ï¼š**

1. æ”»å‡»è€…åˆ›å»ºä¸€ä¸ª**æ¶æ„åˆçº¦ (`Attacker.sol`)**ï¼Œå¹¶ç¡®ä¿å…¶ `receive()` å‡½æ•°ä¼šæ¶ˆè€—è¶…è¿‡ 2300 Gasï¼ˆä¾‹å¦‚ï¼Œåœ¨å‡½æ•°é‡Œå†™å…¥ä¸€ä¸ªå­˜å‚¨å˜é‡ï¼‰ã€‚
2. æ”»å‡»è€…ä½¿ç”¨è¿™ä¸ª `Attacker` åˆçº¦åœ°å€å‚ä¸äº† `UnsafeCrowdfund` çš„ä¼—ç­¹ã€‚
3. ä¼—ç­¹å¤±è´¥åï¼Œæ”»å‡»è€…è°ƒç”¨ `refund()` å‡½æ•°æ¥å–å›èµ„é‡‘ã€‚
4. `UnsafeCrowdfund` åˆçº¦æ‰§è¡Œ `payable(msg.sender).send(amount);`ã€‚
5. ç”±äº `Attacker` åˆçº¦çš„ `receive()` å‡½æ•°éœ€è¦å¤§é‡ Gasï¼Œ`send` æ“ä½œå› ä¸º Gas ä¸è¶³è€Œ**å¤±è´¥**ï¼Œè¿”å› `false`ã€‚
6. ç„¶è€Œï¼Œ`UnsafeCrowdfund` åˆçº¦**æ²¡æœ‰æ£€æŸ¥è¿™ä¸ªè¿”å›å€¼**ï¼Œå®ƒé”™è¯¯åœ°è®¤ä¸ºé€€æ¬¾å·²ç»æˆåŠŸã€‚
7. ä»£ç ç»§ç»­æ‰§è¡Œ `contributions[msg.sender] = 0;`ã€‚
8. **åæœ**ï¼šæ”»å‡»è€…çš„èµ„é‡‘**ä»æœªè¢«çœŸæ­£é€€è¿˜**ï¼Œä½†ä»–åœ¨ä¼—ç­¹åˆçº¦ä¸­çš„ä½™é¢è®°å½•å·²ç»è¢«æ¸…é›¶ã€‚è¿™ç¬”é’±è¢«æ°¸ä¹…åœ°é”åœ¨äº† `UnsafeCrowdfund` åˆçº¦ä¸­ï¼Œæ”»å‡»è€…é­å—äº†èµ„é‡‘æŸå¤±ã€‚å¦‚æœåˆçº¦æœ‰å…¶ä»–é€»è¾‘æ¼æ´ï¼Œè¿™ç¬”â€œæ— äººè®¤é¢†â€çš„èµ„é‡‘è¿˜å¯èƒ½è¢«åˆçº¦æ‰€æœ‰è€…æèµ°ã€‚

------

### 5. å¦‚ä½•ä¿®å¤å’Œé˜²èŒƒ

ä¿®å¤æ–¹æ³•éå¸¸ç›´æ¥ï¼Œå¹¶ä¸”æ˜¯æ‰€æœ‰æ™ºèƒ½åˆçº¦å¼€å‘è€…å¿…é¡»éµå®ˆçš„é»„é‡‘æ³•åˆ™ã€‚

1. **æ°¸è¿œæ£€æŸ¥ä½çº§è°ƒç”¨çš„è¿”å›å€¼**
   - å¿…é¡»ç”¨ä¸€ä¸ªå¸ƒå°”å˜é‡æ¥æ”¶è¿”å›å€¼ï¼Œå¹¶ç«‹å³ç”¨ `require` æ¥æ–­è¨€å…¶ç»“æœã€‚
2. **ä½¿ç”¨ `call` æ¥å‘é€ ETH**
   - æ”¾å¼ƒ `send` å’Œ `transfer`ï¼Œæ‹¥æŠ±æ›´ç°ä»£ã€æ›´å¥å£®çš„ `call` æ–¹å¼ã€‚
3. **éµå¾ªâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€æ¨¡å¼ (Checks-Effects-Interactions)**
   - è¿™èƒ½åŒæ—¶é˜²èŒƒæ­¤æ¼æ´å’Œé‡å…¥æ”»å‡»ã€‚å…ˆæ›´æ–°çŠ¶æ€ï¼Œå†è¿›è¡Œå¤–éƒ¨è°ƒç”¨ã€‚

**å®‰å…¨çš„ä»£ç  ğŸ‘**

Solidity åšå›ºæ€§

```
contract SafeCrowdfund {
    mapping(address => uint256) public contributions;

    // ... å…¶ä»–å‡½æ•° ...

    function refund() public {
        // 1. æ£€æŸ¥ (Checks)
        uint256 amount = contributions[msg.sender];
        require(amount > 0, "No contribution to refund.");

        // 2. ç”Ÿæ•ˆ (Effects) - å…ˆæ›´æ–°çŠ¶æ€
        contributions[msg.sender] = 0;

        // 3. äº¤äº’ (Interactions) - æœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨ï¼Œå¹¶ä¸¥æ ¼æ£€æŸ¥è¿”å›å€¼
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Failed to send Ether");
    }
}
```

## é¢„é˜²åŠæ³•

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ³•æ¥é¢„é˜²æœªæ£€æŸ¥ä½çº§è°ƒç”¨çš„æ¼æ´ï¼š

1. æ£€æŸ¥ä½çº§è°ƒç”¨çš„è¿”å›å€¼ï¼Œåœ¨ä¸Šé¢çš„é“¶è¡Œåˆçº¦ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹æ­£ `withdraw()`ã€‚

   ```
   bool success = payable(msg.sender).send(balance);
   require(success, "Failed Sending ETH!")
   ```

åˆçº¦è½¬è´¦`ETH`æ—¶ï¼Œä½¿ç”¨ `call()`ï¼Œå¹¶åšå¥½é‡å…¥ä¿æŠ¤ã€‚

ä½¿ç”¨`OpenZeppelin`çš„[Addressåº“](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol)ï¼Œå®ƒå°†æ£€æŸ¥è¿”å›å€¼çš„ä½çº§è°ƒç”¨å°è£…å¥½äº†ã€‚

**æ€»ç»“ï¼š** ä½çº§è°ƒç”¨æ˜¯ Solidity ç»™äºˆå¼€å‘è€…çš„â€œåº•å±‚æƒé™â€ï¼Œå®ƒåŠŸèƒ½å¼ºå¤§ä½†ä¹Ÿä¼´éšç€å·¨å¤§çš„è´£ä»»ã€‚æœ€æ ¸å¿ƒçš„è´£ä»»å°±æ˜¯**å¿…é¡»æ‰‹åŠ¨å¤„ç†è°ƒç”¨å¤±è´¥çš„æƒ…å†µ**ã€‚å¿½ç•¥ä½çº§è°ƒç”¨çš„è¿”å›å€¼ï¼Œå°±ç­‰äºåœ¨åˆçº¦ä¸­åŸ‹ä¸‹äº†ä¸€é¢—å®šæ—¶ç‚¸å¼¹ï¼Œéšæ—¶å¯èƒ½å› ä¸ºå¤–éƒ¨åˆçº¦çš„æ„å¤–è¡Œä¸ºè€Œå¯¼è‡´è‡ªèº«çŠ¶æ€é”™ä¹±ï¼Œå¼•å‘èµ„é‡‘æŸå¤±æˆ–å…¶ä»–é€»è¾‘å´©æºƒã€‚